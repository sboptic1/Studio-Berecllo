<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Studio Berecllo — By S.B</title>

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E">

<!-- police interface boutons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<!-- police Cinzel pour le titre -->
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500&display=swap" rel="stylesheet">

<style>
:root{
  --headerH:95px;
  --border:#e6e8ee;
  --gold1:#fff4c2;
  --gold2:#f1d98a;
  --gold3:#e0c066;
  --gold4:#b8943e;
  --gold5:#f9e9ad;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:#f6f7fa;
  color:#111;
  font:15px/1.6 "Helvetica Neue",Helvetica,Arial,sans-serif;
}

/* HEADER (nouvelle version glossy blanche) */
.header-wrap{
  position:fixed;
  inset:0 0 auto 0;
  height:var(--headerH);
  background:radial-gradient(circle at 20% 20%, #ffffff 0%, #f9f9f9 60%, #f0f0f0 100%);
  border-bottom:1px solid rgba(224,192,102,.55); /* liseré doré chaud très léger */
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  z-index:100;
  box-shadow:0 12px 32px rgba(0,0,0,.15), 0 2px 4px rgba(255,255,255,.8) inset;
}

/* bloc gauche (logo) */
.brand{
  display:flex;
  align-items:center;
  height:100%;
}
.brand a{
  display:flex;
  align-items:center;
  height:100%;
  text-decoration:none;
}
.brand svg{
  height:60px;
  width:auto;
  display:block;
}

/* bloc droit (titres) */
.headerTexts{
  text-align:right;
  color:#000;
}
.title{
  /* Cinzel haute gamme */
  font-family:'Cinzel', serif;
  font-weight:400;
  font-size:22px;
  line-height:1.1;
  letter-spacing:.06em;
  color:#000;
  margin:0;
}
.subTitleSmall{
  font-size:12px;
  font-weight:500;
  color:#6b6b6b;
  letter-spacing:.08em;
  text-transform:uppercase;
  margin:4px 0 0 0;
}

/* PAGE LAYOUT */
.page{
  padding-top:calc(var(--headerH) + 20px);
  padding-bottom:60px; /* garde l'espace visuel bas */
}
.wrap{
  max-width:1760px;
  margin:0 auto;
  padding:0 24px;
}
.grid{
  display:grid;
  grid-template-columns:minmax(0,1fr) 420px;
  gap:32px;
}
@media(max-width:1200px){
  .grid{grid-template-columns:1fr;}
}

/* SIGNATURE bas gauche (modifiée) */
.signature{
  position:fixed;
  left:16px;
  bottom:16px;
  font:500 12px/1.4 "Helvetica Neue",Arial,sans-serif;
  color:#6b6b6b;
  background:rgba(255,255,255,.7);
  border:1px solid rgba(0,0,0,.08);
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  backdrop-filter:blur(6px);
  padding:10px 14px;
  z-index:9999;
  text-align:left;
  max-width:220px;
  word-break:break-word;
}

/* CARD PRINCIPALE */
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:20px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
  display:flex;
  flex-direction:column;
}
.viewer{
  position:relative;
  aspect-ratio:2048/1265;
  width:100%;
  border-radius:20px 20px 0 0;
  overflow:hidden;
  background:#eef2f7;
  display:flex;
  align-items:center;
  justify-content:center;
  touch-action:none;
}
#cvWrap{
  position:relative;
  width:100%;
  height:100%;
  transform-origin:center center;
  display:flex;
  align-items:center;
  justify-content:center;
}
canvas#cv{
  width:100%;
  height:100%;
  display:block;
  background:#eef2f7;
}
.model-label{
  position:absolute;
  left:50%;
  bottom:20px;
  transform:translateX(-50%);
  padding:12px 18px;
  border-radius:14px;
  background:rgba(255,255,255,.96);
  border:1px solid rgba(0,0,0,.1);
  backdrop-filter:blur(6px);
  font:300 21px/1.2 "Helvetica Neue",sans-serif;
  letter-spacing:.12em;
  color:#0b0d10;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
  white-space:nowrap;
  max-width:90%;
  overflow:hidden;
  text-overflow:ellipsis;
  text-align:center;
}

/* TOOLBAR */
.toolbar{
  border-top:1px solid var(--border);
  padding:16px 20px;
  display:flex;
  justify-content:flex-end;
  gap:12px;
  flex-wrap:wrap;
}
.btn3d{
  cursor:pointer;
  border:0;
  border-radius:12px;
  padding:12px 18px;
  font:600 15px/1.1 "Helvetica Neue",sans-serif;
  color:#111;
  background:#fff;
  position:relative;
  isolation:isolate;
  box-shadow:
     inset 0 1px 0 rgba(255,255,255,.9),
     0 6px 16px rgba(0,0,0,.08);
  transition:transform .1s,box-shadow .15s;
}
.btn3d::before{
  content:'';
  position:absolute;
  inset:0;
  border-radius:12px;
  padding:2px;
  background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  pointer-events:none;
}
.btn3d:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 26px rgba(0,0,0,.15);
}

/* PANNEAUX CÔTÉ DROIT */
.side{
  display:flex;
  flex-direction:column;
  gap:22px;
}
.panel{
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px 16px 20px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
}
.panelHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.panelHeader h2{
  margin:0;
  font:600 18px/1 'Montserrat',sans-serif;
  color:#111;
  display:flex;
  align-items:center;
  gap:10px;
}

/* GALERIES */
.gal{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:18px;
}
@media(min-width:1400px){
  .gal{grid-template-columns:repeat(4,1fr);}
}
@media(max-width:600px){
  .gal{grid-template-columns:repeat(2,1fr);}
}

/* VIGNETTE */
.thumb{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  width:100%;
  aspect-ratio:1/1;
  cursor:pointer;
  box-shadow:
    0 6px 14px rgba(0,0,0,.06),
    inset 0 1px 0 rgba(255,255,255,.9);
  background:#fafafa;
  transition:all .2s;
  display:flex;
  align-items:center;
  justify-content:center;
}
.thumb:hover{
  transform:translateY(-2px);
  filter:brightness(1.05);
}
.thumbInnerBorder{
  position:absolute;
  inset:0;
  border-radius:12px;
  pointer-events:none;
  box-shadow:
    0 0 0 0 rgba(0,0,0,0);
  transition:box-shadow .2s;
}
.thumb[aria-selected="true"] .thumbInnerBorder{
  box-shadow:
    0 0 10px rgba(255,215,0,.5),
    0 0 0 3px rgba(224,192,102,.9),
    0 6px 14px rgba(0,0,0,.06);
}

/* miniature carrée preview texture */
.thumbImg{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
}

/* label + petite croix */
.thumbLabel{
  position:absolute;
  left:10px;
  bottom:10px;
  right:32px;
  font:600 15px/1.3 'Montserrat',sans-serif;
  letter-spacing:.06em;
  text-align:left;
  word-break:break-word;
  z-index:2;
  text-shadow:0 2px 4px rgba(0,0,0,.6);
  color:#000;
}
.thumbClose{
  position:absolute;
  top:8px;
  right:8px;
  width:22px;
  height:22px;
  border-radius:6px;
  background:rgba(0,0,0,.55);
  color:#fff;
  font-size:12px;
  font-family:"Helvetica Neue",sans-serif;
  line-height:22px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  z-index:3;
  box-shadow:0 2px 4px rgba(0,0,0,.45);
  user-select:none;
}

/* NOTE (debug Drive) masquée visuellement */
.note{
  margin:10px 0 20px 20px;
  font:600 12px 'Montserrat',sans-serif;
  color:#8a8f9a;
  visibility:hidden;
}

/* TOAST */
.toast{
  position:fixed;
  left:50%;
  bottom:40px;
  transform:translateX(-50%);
  background:rgba(255,255,255,.95);
  border:1px solid rgba(0,0,0,.1);
  border-radius:12px;
  padding:12px 22px;
  font:600 15px 'Montserrat',sans-serif;
  color:#000;
  box-shadow:0 4px 20px rgba(0,0,0,.15);
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
}
.toast.show{opacity:1}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header-wrap">
  <div class="brand">
    <a href="https://berecllo.fr/" target="_blank" title="Visiter le site Berecllo" aria-label="Berecllo">
      <!-- LOGO SVG en NOIR -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 173.66" width="200" height="60" aria-hidden="true">
        <defs><style>
          .cls-1 { stroke: #000; stroke-miterlimit: 10; stroke-width: .37px; }
          .cls-1, .cls-2 { fill: #000; }
          .cls-2 { stroke-width: 0px; }
        </style></defs>
        <g><rect class="cls-2" y="133.47" width="350" height="2.39"></rect><g>
          <path class="cls-2" d="M126.86,69.66c-7.58,0-14.09,4.5-19.54,13.49-4.85,7.92-7.28,15.87-7.28,23.86,0,3.96.7,6.83,2.1,8.62,1.4,1.79,3.42,2.69,6.08,2.69,8.89,0,22.63-11.99,23.52-13.05.89-1.06.7-1.86.31-2.34-.39-.48-1.35-.65-2.16-.12-.8.53-8.34,5.9-10.81,7.05-1.83.86-3.51,1.29-5.04,1.29-1.61,0-2.83-.52-3.67-1.57-.84-1.05-1.26-2.89-1.26-5.54,0-1.83.17-3.75.5-5.77,7.09-3.21,11.72-5.43,13.89-6.66,4.33-2.54,7.33-4.98,9.01-7.33,1.68-2.35,2.52-4.74,2.52-7.17s-.7-4.13-2.1-5.46c-1.4-1.32-3.43-1.99-6.08-1.99ZM123.84,86.01c-3.02,3.1-7.54,5.99-13.55,8.68.71-4.26,1.92-8.44,3.64-12.54,1.19-2.8,2.67-4.89,4.42-6.27,1.31-1.04,2.65-1.57,4.03-1.57s2.44.48,3.27,1.43c.84.95,1.26,2.23,1.26,3.83,0,2.13-1.03,4.27-3.08,6.44Z"></path>
          <path class="cls-2" d="M178.41,74.64c.73-.71,1.09-1.57,1.09-2.57s-.38-1.82-1.12-2.55c-.75-.73-1.68-1.09-2.8-1.09-1.54,0-3.44,1.01-5.73,3.04-4.75,4.24-9.01,9.33-12.79,15.29l2.44-10.07c.49-2.1.74-3.39.74-3.88s-.2-.89-.59-1.2c-.39-.32-.92-.48-1.59-.48-1.9,0-4.61,1.02-8.2,2.88-3.94,2.04-9.49,7.37-9.95,8-.52.72-.39,1.26.1,1.63.49.37,1.34.33,1.82-.08.52-.41,4.16-3.86,5.31-4.63,1.16-.76,2.02-1.15,2.58-1.15.82,0,1.23.45,1.23,1.34,0,.41-.17,1.44-.5,3.08-1.42,6.64-3.08,13.66-4.98,21.05l-3.92,15.06h8.34l2.53-10.86c1.68-7.28,2.94-11.91,3.76-13.91.82-2,2.27-4.34,4.34-7.03,2.07-2.69,3.97-4.69,5.71-5.99,1.74-1.31,3.98-2.43,6.74-3.36,2.91-.97,4.73-1.81,5.46-2.52Z"></path>
          <path class="cls-2" d="M246.18,71.22c-1.42-1.04-3.51-1.57-6.27-1.57-4.4,0-8.36,1.29-11.87,3.86-4.48,3.32-8.29,8.1-11.42,14.34-3.13,6.23-4.7,12.3-4.7,18.2,0,3.55.74,6.48,2.21,8.79,1.47,2.31,3.84,3.51,7.09,3.47,9.66-.11,21.23-10.36,22.71-11.69,1.48-1.33,1.26-2.65.98-3.04-.41-.56-1.42-.9-2.26-.39-1.68,1.01-11.36,9.02-15.72,9.02-1.83,0-3.25-.74-4.26-2.24-1.38-1.94-2.07-4.68-2.07-8.22,0-4.81.82-9.6,2.46-14.37,1.64-4.77,3.37-7.99,5.18-9.64,1.81-1.66,3.63-2.49,5.46-2.49,1.42,0,3.19.63,5.32,1.9,2.05,1.19,3.73,1.79,5.04,1.79s2.39-.36,3.14-1.09c.75-.73,1.12-1.67,1.12-2.83,0-1.49-.71-2.76-2.13-3.81Z"></path>
          <path class="cls-2" d="M339.05,73.97c-2.43-2.91-5.47-4.37-9.13-4.37-8.4,0-15.42,4.12-21.06,12.38-4.48,6.64-6.72,13.89-6.72,21.73,0,1.43.14,2.75.38,3.99-5.75,2.91-10.05,4.11-14,4.77-1.85.31-1.58-1.71-1.3-3.2.11-.59,1.57-7.59,4.72-20.99l6.37-26.74c2.25-9.61,3.87-16.04,4.86-19.3,1-3.26,2.11-5.4,3.34-6.41.89-.72,2.21-1.08,3.94-1.08s7.13.91,8.57.91c2.29,0,5.83-2.01,5.83-5.67,0-4.12-3.11-5.99-6.13-5.99-5.35,0-7.54,4.16-12.36,7.04-4.82,2.88-8.55,6.93-11.18,12.14-1.7,3.45-3.8,10.23-6.31,20.35l-6.88,28.01c-1.46,5.95-2.52,10.77-3.17,14.47-7.41,4.16-12.53,5.7-17.18,6.47-1.85.31-1.58-1.71-1.3-3.2.11-.59,1.57-7.59,4.72-20.99l6.37-26.74c2.25-9.61,3.87-16.04,4.86-19.3,1-3.26,2.11-5.4,3.34-6.41.89-.72,2.21-1.08,3.94-1.08s7.13.91,8.57.91c2.29,0,5.83-2.01,5.83-5.67,0-4.12-3.11-5.99-6.13-5.99-5.35,0-7.54,4.16-12.36,7.04-4.82,2.88-8.55,6.93-11.18,12.14-1.7,3.45-3.8,10.23-6.31,20.35l-6.88,28.01c-2.64,10.72-3.95,17.78-3.95,21.19,0,1.74.43,3.12,1.28,4.12.85,1,1.94,1.51,3.26,1.5,7.94-.05,16.69-4.55,22.47-7.67-.08.79-.12,1.48-.12,2.06,0,1.74.43,3.12,1.28,4.12.85,1,1.94,1.51,3.26,1.5,7.36-.05,15.42-3.92,21.16-6.97.55,1.13,1.24,2.15,2.08,3.05,2.44,2.61,5.66,3.92,9.66,3.92,6.49,0,12.66-3.29,18.48-9.88,5.82-6.59,8.73-14.03,8.73-22.32,0-5.19-1.21-9.24-3.64-12.15ZM328.18,108.13c-2.58,3.88-5.43,5.82-8.57,5.82-2.24,0-4.03-1.03-5.38-3.08-1.83-2.8-2.74-6.62-2.74-11.48,0-7.99,1.49-14.25,4.45-18.79,2.97-4.54,6.04-6.8,9.21-6.8,2.28,0,4.17,1.19,5.68,3.58,1.51,2.39,2.27,6.38,2.27,11.98,0,7.47-1.64,13.72-4.93,18.76Z"></path>
          <path class="cls-2" d="M92.61,55.59c3.28-4.14,4.91-8.72,4.91-13.77,0-4.16-1.5-7.81-4.48-10.98-1.07-.96-1.42-1.55-4.08-3.4-4.8-3.11-11.48-4.66-20.06-4.66-11.49,0-22.01,2.47-31.58,7.41-9.56,4.94-16.95,11.51-22.18,19.71-5.22,8.2-7.84,16.66-7.84,25.4,0,6.35,1.52,11.68,4.56,16,3.04,4.32,4.03,6.98,7.45,7.16,2.26.12,6.1-1.71,6.04-5.43-.04-2.26-.73-5.25-5.37-6.22-1.9-.4-3.8-2.26-4.42-3.09-1.04-1.4-1.83-2.95-2.38-4.65-.55-1.69-.82-3.52-.82-5.5,0-7.23,2.38-14.45,7.14-21.66,4.75-7.21,11.39-13.04,19.92-17.52,8.53-4.47,17.49-6.71,26.9-6.71,6.65,0,11.65,1.35,15.01,4.06,3.35,2.7,5.03,6.27,5.03,10.69,0,6.35-2.32,11.82-6.97,16.43-4.65,4.6-11.57,6.91-20.76,6.91l4.58-17.74c1.31-4.4,1.75-6.52,3.59-12.63-7.43,1.22-13.13,2.04-19.2,3.12l-.93,3.82c.62-.16,1.14-.23,1.56-.23.99,0,1.8.3,2.45.9.65.6.98,1.3.98,2.08,0,.99-.23,2.46-.7,4.4l-11.54,45.31c-2.03,7.87-4.2,12.96-6.51,15.26-2.31,2.31-6.2,3.61-11.65,3.92l-1.17,4.29c6.99.09,33.35-.08,37.11-.39,6.94-.56,13.65-1.65,20.07-4.95,6.42-3.3,11.28-7.46,14.58-12.47,3.3-5.01,4.95-10.33,4.95-15.94,0-3.43-.72-6.47-2.14-9.12-1.43-2.65-3.47-4.84-6.12-6.58-2.65-1.74-6.27-2.97-10.84-3.7,6.65-2.23,11.61-5.42,14.89-9.56ZM80.41,77.13c1.74,2.47,2.61,5.42,2.61,8.85,0,6.92-2,13.48-6.98,18.81-5.13,5.5-7.81,6.32-15.03,7.25-3.35.43-11.27.68-15.94-.47.7-1.57,6.34-17.31,8.36-25.43l3.97-15.69c7.94,0,13.33.5,16.16,1.48,2.83.99,5.11,2.72,6.85,5.19Z"></path>
          <path class="cls-2" d="M199.48,69.66c-7.58,0-14.09,4.5-19.54,13.49-4.85,7.92-7.28,15.87-7.28,23.86,0,3.96.7,6.83,2.1,8.62,1.4,1.79,3.42,2.69,6.07,2.69,8.89,0,22.63-11.99,23.52-13.05.89-1.06.7-1.86.31-2.34-.39-.48-1.35-.65-2.16-.12-.8.53-8.34,5.9-10.81,7.05-1.83.86-3.51,1.29-5.04,1.29-1.61,0-2.83-.52-3.67-1.57-.84-1.05-1.26-2.89-1.26-5.54,0-1.83.17-3.75.5-5.77,7.09-3.21,11.72-5.43,13.89-6.66,4.33-2.54,7.33-4.98,9.01-7.33,1.68-2.35,2.52-4.74,2.52-7.17s-.7-4.13-2.1-5.46c-1.4-1.32-3.43-1.99-6.08-1.99ZM196.46,86.01c-3.03,3.1-7.54,5.99-13.55,8.68.71-4.26,1.92-8.44,3.64-12.54,1.19-2.8,2.67-4.89,4.42-6.27,1.31-1.04,2.65-1.57,4.03-1.57s2.44.48,3.27,1.43c.84.95,1.26,2.23,1.26,3.83,0,2.13-1.03,4.27-3.08,6.44Z"></path></g></g>
        <path class="cls-2" d="M253.54,18.14l-1.37-1.23c-1.74-1.56-3.57-2.15-5.59-1.83-1.64.26-3.1,1.12-4.43,1.89-.27.16-.54.31-.81.46-1.11.62-2.72,1.64-3.86,3.39-1.13,1.72-2.4,2.58-4.23,2.87-1.08.17-2.49.14-3.99.07l-.54-.02c-.91-.04-1.83.02-2.84.18-1.89.3-3.65.9-5.6,1.59-.6.21-1.18.32-1.78.34-1.81.05-3.83-.82-6.35-2.72-1.87-1.42-3.65-1.81-5.62-2.15-1.6-.28-3.71-1.68-6.26-4.16-1.34-1.3-2.59-3.21-3.8-5.07-.49-.75-.99-1.52-1.51-2.26-.35-.5-.71-1-1.08-1.52-1.11-1.55-2.26-3.16-3.18-4.89-.66-1.24-1.83-3.37-3.86-3.05-1.26.2-2.07,1.25-2.68,2.22-.06.06-.33.19-.5.27-.36.17-.81.39-1.25.74-.29.23-.6.44-.94.67-1.04.71-2.33,1.59-3.13,3.16-.89,1.73-1.54,3.66-2.2,5.58-.4,1.17-.82,2.39-1.27,3.49-.46,1.11-.91,1.57-.98,1.62-.38.16-1.03.23-1.68.28-.41.03-.84.07-1.29.14-.51.08-.97.2-1.38.36,0,0,0,0,0,0-.23-.26-.62-1.08-.8-1.44-.18-.38-.37-.78-.59-1.17-.82-1.49-2.54-2.35-4.6-2.29-.29,0-.59.04-.87.08-1.37.22-2.51.84-3.21,1.76-.72.93-1.34,1.55-1.84,1.82-.5.27-1,.56-1.51.85-1.5.87-3.2,1.85-4.66,1.93-.72.02-2.31-.96-3.72-2.64-.26-.31-.51-.63-.79-.98-1.27-1.62-2.85-3.65-5.72-3.57-.28,0-.56.03-.85.08l-.86.14c-3.94.63-8.13,1.46-12.21,3.9-.39.23-.88.39-1.55.5-.44.07-.91.11-1.4.16-.51.05-1.08.1-1.69.2-1.18.19-2.38.41-3.6.64-1.22.23-2.49.46-3.73.66-1.97.32-3.59.5-5.09.58-.56.03-1.14.09-1.72.18-1.72.28-3.35.81-4.92,1.46-.85.35-1.88,1.02-1.62,2.53.53,1.57,2.11,1.07,2.87.92,1.49-.55,2.68-.95,4.18-1.19.44-.07.88-.12,1.32-.14,1.63-.09,3.38-.28,5.49-.62,1.27-.21,2.56-.44,3.85-.68,1.14-.21,2.33-.43,3.52-.62.44-.07.93-.12,1.4-.16.53-.05,1.08-.1,1.64-.19,1.16-.19,2.07-.5,2.89-.98,3.51-2.09,7.3-2.83,10.88-3.41l.85-.13c1.2-.19,1.75.35,3.16,2.15l.05.06c.26.33.53.67.81,1.01,1.01,1.21,3.67,4.01,6.58,3.93h.14c.26-.02.53-.05.8-.09,2-.32,3.78-1.35,5.49-2.34l.06-.04c.45-.26.89-.51,1.34-.75,1.01-.54,1.99-1.45,3.07-2.86.06-.07.33-.24.8-.31.12-.02.25-.03.37-.03.75-.02,1.25.24,1.35.42.17.31.33.65.49.98.73,1.53,1.86,3.91,4.54,3.48.27-.04.56-.12.87-.24.38-.15,1.04-.22,1.63-.26.39-.03.84-.07,1.29-.14.58-.09,1.09-.23,1.54-.42,1.6-.67,2.59-2.6,3.04-3.69.5-1.21.93-2.47,1.35-3.69l.02-.07c.59-1.74,1.21-3.54,1.97-5.02.35-.69,1.06-1.18,1.9-1.75.37-.25.76-.52,1.14-.82.1-.08.32-.18.51-.28.55-.26,1.37-.65,1.97-1.5.08.14.18.31.28.51,1.04,1.95,2.26,3.66,3.45,5.32.35.48.69.97,1.03,1.46.49.7.97,1.45,1.44,2.17,1.32,2.02,2.68,4.1,4.31,5.69,3.17,3.08,5.76,4.71,8.16,5.12,1.7.29,2.82.53,4.06,1.48,2.01,1.52,5.1,3.53,8.68,3.43.4-.01.81-.05,1.2-.11.56-.09,1.12-.23,1.67-.43,1.77-.63,3.37-1.17,4.95-1.42.76-.12,1.45-.17,2.09-.14l.54.02c1.59.07,3.35.11,4.74-.11,2.9-.47,5.06-1.91,6.8-4.54.53-.8,1.33-1.49,2.53-2.15.3-.17.6-.34.91-.52,1.11-.64,2.15-1.25,3.1-1.4.11-.02.24-.03.38-.04.72-.02,1.45.31,2.23,1l1.39,1.24c4.33,3.87,11.79,9.98,13.12,10.72,1.1.59,1.92.25,2.32-.22.4-.46.63-1.44.04-2.24-.59-.81-8.69-7.26-13.01-11.12Z"></path>
        <g>
          <path class="cls-1" d="M20.99,173.03c-1.93,0-3.72-.48-5.37-1.45-1.65-.97-2.95-2.28-3.91-3.94-.96-1.66-1.43-3.47-1.43-5.42s.48-3.76,1.43-5.42c.95-1.66,2.26-2.97,3.91-3.94,1.65-.97,3.44-1.45,5.37-1.45s3.72.48,5.37,1.45c1.65.97,2.95,2.28,3.91,3.94.95,1.66,1.43,3.47,1.43,5.42s-.48,3.76-1.43,5.42c-.96,1.66-2.26,2.97-3.91,3.94-1.65.97-3.44,1.45-5.37,1.45ZM20.99,152.91c-1.67,0-3.21.42-4.62,1.25-1.41.84-2.53,1.96-3.37,3.39-.84,1.42-1.25,2.98-1.25,4.67s.42,3.25,1.25,4.67c.84,1.42,1.96,2.55,3.37,3.39,1.41.84,2.95,1.25,4.62,1.25s3.21-.42,4.62-1.25c1.41-.84,2.53-1.96,3.35-3.39.82-1.42,1.24-2.98,1.24-4.67s-.41-3.25-1.24-4.67c-.83-1.42-1.94-2.55-3.35-3.39-1.41-.84-2.95-1.25-4.62-1.25Z"></path>
          <path class="cls-1" d="M35.87,172.8l-.03-21.16h7.55c1.24,0,2.38.27,3.43.81,1.05.54,1.89,1.27,2.51,2.18.62.91.93,1.91.93,3s-.31,2.06-.93,2.98c-.62.92-1.45,1.66-2.51,2.2-1.05.54-2.2.81-3.43.81h-6.06v9.18h-1.46ZM37.33,162.09h6.06c.98,0,1.88-.2,2.7-.6.82-.4,1.48-.94,1.97-1.63s.73-1.43.73-2.23-.24-1.58-.73-2.26-1.15-1.23-1.97-1.63c-.82-.4-1.73-.6-2.7-.6h-6.09l.03,8.95Z"></path>
          <path class="cls-1" d="M71.35,151.64v1.5h-8.37v19.66h-1.5v-19.66h-8.4v-1.5h18.26Z"></path>
          <path class="cls-1" d="M75.87,172.8v-21.16h1.46v21.16h-1.46Z"></path>
          <path class="cls-1" d="M92.77,173.03c-1.93,0-3.72-.49-5.37-1.46-1.65-.98-2.95-2.3-3.91-3.96-.96-1.66-1.43-3.47-1.43-5.42s.48-3.75,1.43-5.4c.95-1.65,2.26-2.96,3.91-3.94,1.65-.98,3.44-1.46,5.37-1.46,1.5,0,2.93.31,4.31.93,1.38.62,2.59,1.49,3.63,2.62l-1.14,1.01c-.87-.98-1.89-1.74-3.08-2.28-1.18-.54-2.43-.81-3.73-.81-1.67,0-3.21.42-4.62,1.25-1.41.84-2.53,1.97-3.37,3.4-.84,1.43-1.25,3-1.25,4.69s.42,3.26,1.25,4.69c.84,1.43,1.96,2.57,3.37,3.4,1.41.84,2.95,1.25,4.62,1.25,1.39,0,2.71-.3,3.96-.91,1.25-.61,2.32-1.45,3.21-2.54l1.17.91c-1.02,1.28-2.26,2.27-3.71,2.98-1.45.71-2.99,1.06-4.62,1.06Z"></path>
          <path class="cls-1" d="M105.66,172.8v-21.16h1.46v21.16h-1.46Z"></path>
          <path class="cls-1" d="M113.18,172.8v-21.16h13.71v1.5h-12.24v8.33h9.54v1.5h-9.54v8.3h12.24v1.53h-13.71Z"></path>
          <path class="cls-1" d="M133.36,155.61v17.19h-1.46v-21.42l14.65,17.51v-17.25h1.47v21.52l-14.65-17.55Z"></path>
          <path class="cls-1" d="M167.1,164.61c.55.81.83,1.69.83,2.62,0,.8-.2,1.57-.59,2.3-.39.73-.96,1.36-1.69,1.9-1.52,1.09-3.29,1.63-5.31,1.63-1,0-1.95-.14-2.86-.42-.91-.28-1.73-.68-2.44-1.2-1.24-.91-1.99-2.03-2.25-3.35l1.4-.78c.07,1.19.65,2.17,1.76,2.93.56.43,1.23.76,1.99.99.76.23,1.56.34,2.41.34,1.74,0,3.2-.44,4.39-1.33,1.15-.85,1.73-1.84,1.73-3,0-.67-.21-1.3-.64-1.89-.42-.59-1.01-1.08-1.77-1.5-.72-.37-2-.66-3.84-.88-.15-.02-.7-.11-1.64-.26-.94-.15-1.75-.39-2.43-.72-1.06-.52-1.9-1.21-2.51-2.07-.61-.86-.91-1.78-.91-2.78,0-.8.2-1.56.6-2.26.4-.71.97-1.33,1.71-1.87.72-.52,1.53-.92,2.44-1.2.91-.28,1.87-.42,2.86-.42,2.02,0,3.79.54,5.31,1.63,1.26.96,2,2.06,2.21,3.32l-1.4.78c-.02-.54-.18-1.06-.47-1.56-.29-.5-.71-.95-1.25-1.37-.59-.43-1.26-.76-2.02-.99-.76-.23-1.55-.34-2.38-.34s-1.62.11-2.39.34c-.77.23-1.44.56-2,.99-.56.41-1,.87-1.3,1.38-.3.51-.46,1.04-.46,1.58,0,.67.25,1.34.75,2,.5.66,1.12,1.18,1.86,1.55.46.22.96.37,1.51.47.55.1,1.26.2,2.13.31.15.02.53.08,1.14.16.61.09,1.19.21,1.76.36.56.15,1.04.34,1.43.55,1,.56,1.77,1.25,2.33,2.07Z"></path>
          <path class="cls-1" d="M181.28,164.3c-.03-1.92,1.53-3.42,3.42-3.42s3.42,1.5,3.42,3.39-1.5,3.42-3.42,3.42-3.42-1.46-3.42-3.39Z"></path>
          <path class="cls-1" d="M197.98,172.8v-21.16h1.46v19.69h11.88v1.46h-13.35Z"></path>
          <path class="cls-1" d="M223.57,173.03c-1.06,0-2.09-.21-3.08-.63-.99-.42-1.86-1.03-2.62-1.81-.76-.74-1.34-1.61-1.74-2.6-.4-1-.6-2.05-.6-3.16v-13.18h1.46v13.18c0,.91.17,1.78.5,2.6.34.83.81,1.54,1.42,2.15.63.63,1.35,1.11,2.15,1.45.8.34,1.64.5,2.51.5s1.74-.17,2.54-.5c.8-.34,1.52-.82,2.15-1.45s1.08-1.32,1.42-2.15c.34-.82.5-1.69.5-2.6v-13.18h1.46v13.18c0,1.11-.2,2.16-.6,3.16-.4,1-.98,1.87-1.74,2.6-.76.78-1.63,1.38-2.6,1.81s-2.02.63-3.13.63Z"></path>
          <path class="cls-1" d="M238.51,155.61v17.19h-1.46v-21.42l14.65,17.51v-17.25h1.46v21.52l-14.65-17.55Z"></path>
          <path class="cls-1" d="M258.82,172.8v-21.16h13.71v1.5h-12.24v8.33h9.54v1.5h-9.54v8.3h12.24v1.53h-13.71Z"></path>
          <path class="cls-1" d="M295.22,151.64v1.5h-8.37v19.66h-1.5v-19.66h-8.4v-1.5h18.26Z"></path>
          <path class="cls-1" d="M299.74,172.8v-21.16h1.46v21.16h-1.46Z"></path>
          <path class="cls-1" d="M307.26,172.8v-21.16h13.71v1.5h-12.24v8.33h9.54v1.5h-9.54v8.3h12.24v1.53h-13.71Z"></path>
          <path class="cls-1" d="M338.45,172.8l-8.79-10.68h2.6c1.61,0,2.91-.21,3.91-.62.74-.35,1.38-.87,1.92-1.58.54-.71.81-1.48.81-2.33,0-.76-.23-1.48-.68-2.16s-1.11-1.24-1.95-1.68c-.85-.43-1.82-.65-2.93-.65h-5.92v19.69h-1.46v-21.16h7.39c1,0,1.93.16,2.8.47.87.32,1.63.77,2.28,1.35.63.56,1.11,1.2,1.45,1.92.34.72.5,1.45.5,2.21,0,1.19-.36,2.26-1.07,3.21s-1.56,1.62-2.54,2.03c-.67.3-1.33.49-1.97.57-.64.08-1.32.11-2.03.11l7.65,9.28h-1.95Z"></path>
        </g>
      </svg>
    </a>
  </div>
  <div class="headerTexts">
    <h1 class="title">Studio Berecllo - By S.B</h1>
    <div class="subTitleSmall">Configuration monture • rendu photo-réaliste</div>
  </div>
</header>

<!-- PAGE -->
<div class="page">
  <div class="wrap">
    <div class="grid">

      <!-- ZONE CENTRALE -->
      <div class="card">
        <div class="viewer" id="viewer">
          <div id="cvWrap">
            <canvas id="cv" width="2048" height="1265"></canvas>
          </div>
          <div class="model-label" id="modelLabel">—</div>
        </div>
        <div class="toolbar">
          <button class="btn3d" id="btnFav">❤ Favoris</button>
          <button class="btn3d" id="btnShare">⇪ Partager</button>
          <button class="btn3d" id="btnExport">⬇ Exporter</button>
        </div>
        <p class="note" id="driveNote">...</p>
      </div>

      <!-- COLONNE DROITE -->
      <aside class="side">
        <div class="panel">
          <div class="panelHeader"><h2>Faces</h2></div>
          <div id="galFaces" class="gal"></div>
        </div>

        <div class="panel">
          <div class="panelHeader"><h2>Branches</h2></div>
          <div id="galTemples" class="gal"></div>
        </div>

        <div class="panel">
          <div class="panelHeader"><h2>Favoris</h2></div>
          <div id="galFavs" class="gal"></div>
        </div>
      </aside>

    </div>
  </div>
</div>

<!-- SIGNATURE BAS GAUCHE -->
<div class="signature">
  Sébastien BOURDON<br>
  sb.optic1@gmail.com<br>
  06&nbsp;62&nbsp;71&nbsp;27&nbsp;52
</div>

<div id="toast" class="toast">⭐ Ajouté aux favoris</div>

<script>
/* CONFIG DRIVE */
const DRIVE = {
  API_KEY: "AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",
  FACES_FOLDER_ID:   "1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",
  TEMPLES_FOLDER_ID: "1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",
  WORKER_URL: "https://berecllo-proxy1.sb-optic1.workers.dev"
};

/* DOM */
const cv       = document.getElementById('cv');
const ctx      = cv.getContext('2d',{willReadFrequently:true});
const cvWrap   = document.getElementById('cvWrap');

const modelLabel = document.getElementById('modelLabel');

const viewer     = document.getElementById('viewer');
const galFaces   = document.getElementById('galFaces');
const galTemples = document.getElementById('galTemples');
const galFavs    = document.getElementById('galFavs');

const btnFav     = document.getElementById('btnFav');
const btnShare   = document.getElementById('btnShare');
const btnExport  = document.getElementById('btnExport');

const driveNote  = document.getElementById('driveNote');
const toast      = document.getElementById('toast');

/* STATE */
const state = {
  faces: [],
  temples: [],
  selFace: null,
  selTemples: null,
  favs: [],
  tol: 60,
  zoomScale: 1.0,
  dbReady:false,
  dbFailed:false
};

/* IndexedDB */
let db;
const DB_NAME='berecllo-store';
const DB_VER=4;

function openDB(){
  return new Promise((resolve,reject)=>{
    try{
      const req=indexedDB.open(DB_NAME,DB_VER);
      req.onupgradeneeded=e=>{
        const d=e.target.result;
        if(!d.objectStoreNames.contains('images')){
          d.createObjectStore('images',{keyPath:'id'});
        }
        if(!d.objectStoreNames.contains('meta')){
          d.createObjectStore('meta',{keyPath:'key'});
        }
      };
      req.onsuccess=()=>{
        db=req.result;
        state.dbReady=true;
        resolve(db);
      };
      req.onerror=()=>{
        state.dbFailed=true;
        reject(req.error||new Error("IndexedDB open error"));
      };
    }catch(err){
      state.dbFailed=true;
      reject(err);
    }
  });
}
function idFor(type,name){ return `${type}|${name}`; }

function putImageRecord(type,name,blob,modified,thumbDataURL,textColor){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readwrite');
    tx.objectStore('images').put({
      id:idFor(type,name),
      name,
      type,
      blob,
      modified:modified||null,
      thumbDataURL:thumbDataURL||null,
      textColor:textColor||null
    });
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("putImageRecord fail"));
  });
}
function deleteImageRecord(type,name){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readwrite');
    tx.objectStore('images').delete(idFor(type,name));
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("deleteImageRecord fail"));
  });
}
function getAllImages(){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve([]);
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readonly');
    const r=tx.objectStore('images').getAll();
    r.onsuccess=()=>resolve(r.result||[]);
    r.onerror =()=>reject(r.error||new Error("getAllImages fail"));
  });
}
function saveMeta(key,val){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('meta','readwrite');
    tx.objectStore('meta').put({key,value:val});
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("saveMeta fail"));
  });
}
function loadMeta(key){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve(null);
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('meta','readonly');
    const r=tx.objectStore('meta').get(key);
    r.onsuccess=()=>resolve(r.result?r.result.value:null);
    r.onerror =()=>reject(r.error||new Error("loadMeta fail"));
  });
}

/* utils image */
function imgFromBlob(blob){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>res(img);
    img.onerror=(e)=>rej(e);
    img.src=URL.createObjectURL(blob);
  });
}

/* détourage face */
function removeBackgroundAuto(img,tol){
  const w=img.naturalWidth||img.width;
  const h=img.naturalHeight||img.height;
  const c=document.createElement('canvas');
  c.width=w; c.height=h;
  const x=c.getContext('2d',{willReadFrequently:true});
  x.drawImage(img,0,0);
  const data=x.getImageData(0,0,w,h);
  const d=data.data;

  const margin=Math.floor(Math.min(w,h)*0.03);
  const steps=10;
  let r=0,g=0,b=0,n=0;
  function pick(sx,sy){
    const o=(sy*w+sx)*4;
    r+=d[o]; g+=d[o+1]; b+=d[o+2]; n++;
  }
  for(let i=0;i<=steps;i++){
    const t=Math.floor(i*(w-1)/steps);
    const u=Math.floor(i*(h-1)/steps);
    pick(t,margin); pick(t,h-1-margin);
    pick(margin,u); pick(w-1-margin,u);
  }
  r/=n; g/=n; b/=n;

  for(let i=0;i<d.length;i+=4){
    const dr=d[i]-r, dg=d[i+1]-g, db=d[i+2]-b;
    const dist=Math.sqrt(dr*dr+dg*dg+db*db);
    if(dist<tol){
      d[i+3]=0;
    }
  }
  x.putImageData(data,0,0);
  const out=new Image();
  out.src=c.toDataURL('image/png');
  return out;
}

/* miniature + contraste texte */
function makeThumbInfo(img){
  const SIZE=200;
  const c=document.createElement('canvas');
  c.width=SIZE;
  c.height=SIZE;
  const x=c.getContext('2d');

  const iw=img.naturalWidth||img.width;
  const ih=img.naturalHeight||img.height;
  const aspect = iw/ih;

  let sx,sy,sw,sh;
  if(aspect>1){
    sh=ih;
    sw=ih;
    sx=(iw-sw)/2;
    sy=0;
  }else{
    sw=iw;
    sh=iw;
    sx=0;
    sy=(ih-sh)/2;
  }

  x.drawImage(img,sx,sy,sw,sh,0,0,SIZE,SIZE);

  const data=x.getImageData(0,0,SIZE,SIZE).data;
  let rr=0,gg=0,bb=0,n=0;
  for(let i=0;i<data.length;i+=4){
    rr+=data[i];
    gg+=data[i+1];
    bb+=data[i+2];
    n++;
  }
  rr/=n; gg/=n; bb/=n;
  const lum = 0.299*rr + 0.587*gg + 0.114*bb;
  const textColor = lum < 140 ? '#fff' : '#000';

  return {
    thumbDataURL: c.toDataURL('image/jpeg',0.8),
    textColor
  };
}

/* labels */
function faceLabel(n){
  return n.replace(/\.[^.]+$/,'').toUpperCase();
}
function templesLabel(n){
  return n.replace(/\.[^.]+$/,'').toLowerCase();
}

/* rendu principal */
function updateLabel(){
  const f=state.selFace    ? faceLabel(state.selFace.name)     : '';
  const t=state.selTemples ? templesLabel(state.selTemples.name): '';
  modelLabel.textContent = (f && t) ? `${f} - ${t}` : (f || t || '—');
}
function redraw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(state.selTemples?.img){
    ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height);
  }
  if(state.selFace?.proc){
    ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height);
  }
  updateLabel();
  persistSelection().catch(()=>{});
}

/* sélection / suppression */
function selectAndRedraw(isFace,obj){
  if(isFace) state.selFace=obj;
  else       state.selTemples=obj;
  redraw();
  rebuildAllGalleries();
}

async function removeVariant(isFace,name){
  const list = isFace ? state.faces : state.temples;
  const idx=list.findIndex(x=>x.name===name);
  if(idx>=0){
    if(isFace && state.selFace && state.selFace.name===name){
      state.selFace=null;
    }
    if(!isFace && state.selTemples && state.selTemples.name===name){
      state.selTemples=null;
    }
    list.splice(idx,1);
  }
  const type=isFace?'face':'temples';
  await deleteImageRecord(type,name).catch(()=>{});

  await persistLists().catch(()=>{});
  redraw();
  rebuildAllGalleries();
}

/* Vignettes */
function buildThumbEl(isFace,obj){
  const wrap=document.createElement('div');
  wrap.className='thumb';
  wrap.setAttribute('aria-selected',
    (isFace ? state.selFace===obj : state.selTemples===obj) ? 'true':'false'
  );

  const border=document.createElement('div');
  border.className='thumbInnerBorder';
  wrap.appendChild(border);

  const imgDiv=document.createElement('div');
  imgDiv.className='thumbImg';
  if(obj.thumbDataURL){
    imgDiv.style.backgroundImage=`url("${obj.thumbDataURL}")`;
  }else{
    imgDiv.style.backgroundColor='#ddd';
  }
  wrap.appendChild(imgDiv);

  const lbl=document.createElement('div');
  lbl.className='thumbLabel';
  lbl.style.color = obj.textColor || '#000';
  lbl.textContent = isFace? faceLabel(obj.name) : templesLabel(obj.name);
  wrap.appendChild(lbl);

  const close=document.createElement('div');
  close.className='thumbClose';
  close.textContent='✕';
  close.addEventListener('click',e=>{
    e.stopPropagation();
    removeVariant(isFace,obj.name);
  });
  wrap.appendChild(close);

  wrap.addEventListener('click',()=>{
    selectAndRedraw(isFace,obj);
  });

  return wrap;
}

function rebuildGallery(dom,list,isFace){
  dom.innerHTML='';
  list.forEach(o=>{
    dom.appendChild(buildThumbEl(isFace,o));
  });
}
function renderFavs(){
  galFavs.innerHTML='';
  state.favs.forEach(fv=>{
    const fObj=state.faces.find(x=>x.name===fv.face);
    const wrap=document.createElement('div');
    wrap.className='thumb';
    wrap.setAttribute('aria-selected','false');

    const border=document.createElement('div');
    border.className='thumbInnerBorder';
    wrap.appendChild(border);

    const imgDiv=document.createElement('div');
    imgDiv.className='thumbImg';
    if(fObj && fObj.thumbDataURL){
      imgDiv.style.backgroundImage=`url("${fObj.thumbDataURL}")`;
    }else{
      imgDiv.style.backgroundColor='#ccc';
    }
    wrap.appendChild(imgDiv);

    const lbl=document.createElement('div');
    lbl.className='thumbLabel';
    lbl.style.color = fObj?.textColor || '#000';
    lbl.textContent = fv.label;
    wrap.appendChild(lbl);

    wrap.addEventListener('click',()=>{
      const faceObj   = state.faces.find(x=>x.name===fv.face);
      const templObj  = state.temples.find(x=>x.name===fv.temples);
      if(faceObj)  state.selFace=faceObj;
      if(templObj) state.selTemples=templObj;
      redraw();
      rebuildAllGalleries();
    });

    galFavs.appendChild(wrap);
  });
}
function rebuildAllGalleries(){
  rebuildGallery(galFaces,state.faces,true);
  rebuildGallery(galTemples,state.temples,false);
  renderFavs();
}

/* Favoris / Export / Share */
function slugifyForFilename(s){
  return (s||'berecllo')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\- ]+/g,'')
    .replace(/\s+/g,'_')
    .replace(/_+/g,'_')
    .replace(/^_+|_+$/g,'');
}
function toastMsg(t){
  toast.textContent=t;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1400);
}

btnExport.onclick = ()=>cv.toBlob(b=>{
  const base=slugifyForFilename(modelLabel.textContent||'berecllo');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download=base+'.png';
  a.click();
});
btnShare.onclick = ()=>cv.toBlob(async b=>{
  const base=slugifyForFilename(modelLabel.textContent||'berecllo');
  const f=new File([b],base+'.png',{type:'image/png'});
  if(navigator.canShare && navigator.canShare({files:[f]})){
    try{
      await navigator.share({
        files:[f],
        title:'Berecllo',
        text:modelLabel.textContent||''
      });
    }catch(e){}
  }
});
btnFav.onclick = async ()=>{
  if(!state.selFace||!state.selTemples) return;
  const label=modelLabel.textContent;
  if(state.favs.find(x=>x.face===state.selFace.name && x.temples===state.selTemples.name)) return;
  state.favs.unshift({
    face:state.selFace.name,
    temples:state.selTemples.name,
    label
  });
  if(state.favs.length>5) state.favs.pop();
  await saveMeta('favs',state.favs).catch(()=>{});
  renderFavs();
  toastMsg('⭐ Ajouté aux favoris');
};

/* Persistance listes/sélection */
async function persistLists(){
  const fNames=state.faces.map(x=>x.name);
  const tNames=state.temples.map(x=>x.name);
  await saveMeta('facesNames',fNames).catch(()=>{});
  await saveMeta('templesNames',tNames).catch(()=>{});
}
async function persistSelection(){
  await saveMeta('selection',{
    face:state.selFace?.name||null,
    temples:state.selTemples?.name||null
  }).catch(()=>{});
}

/* reload cache local */
async function reloadFromIndexedDB(){
  const arr=await getAllImages().catch(()=>[]);
  const facesNames   = await loadMeta('facesNames').catch(()=>null) || [];
  const templesNames = await loadMeta('templesNames').catch(()=>null)|| [];
  const sel          = await loadMeta('selection').catch(()=>null) || {face:null,temples:null};
  const favs         = await loadMeta('favs').catch(()=>[]) || [];

  state.favs = favs.slice(0,5);

  const map={};
  for(const rec of arr){
    map[idFor(rec.type,rec.name)] = rec;
  }

  const allFacesNames=[...new Set([...facesNames,...arr.filter(x=>x.type==='face').map(x=>x.name)])];
  for(const nm of allFacesNames){
    const rec=map[idFor('face',nm)];
    if(!rec) continue;
    const img=await imgFromBlob(rec.blob);

    let thumbDataURL=rec.thumbDataURL;
    let textColor=rec.textColor;
    if(!thumbDataURL || !textColor){
      const tinfo=makeThumbInfo(img);
      thumbDataURL=tinfo.thumbDataURL;
      textColor=tinfo.textColor;
      await putImageRecord('face',nm,rec.blob,rec.modified,thumbDataURL,textColor).catch(()=>{});
    }

    const proc=removeBackgroundAuto(img,state.tol);
    const o={
      name:nm,
      img,
      proc,
      modified:rec.modified||null,
      thumbDataURL,
      textColor
    };
    state.faces.push(o);
    proc.onload=()=>redraw();
  }

  const allTemplNames=[...new Set([...templesNames,...arr.filter(x=>x.type==='temples').map(x=>x.name)])];
  for(const nm of allTemplNames){
    const rec=map[idFor('temples',nm)];
    if(!rec) continue;
    const img=await imgFromBlob(rec.blob);

    let thumbDataURL=rec.thumbDataURL;
    let textColor=rec.textColor;
    if(!thumbDataURL || !textColor){
      const tinfo=makeThumbInfo(img);
      thumbDataURL=tinfo.thumbDataURL;
      textColor=tinfo.textColor;
      await putImageRecord('temples',nm,rec.blob,rec.modified,thumbDataURL,textColor).catch(()=>{});
    }

    const o={
      name:nm,
      img,
      modified:rec.modified||null,
      thumbDataURL,
      textColor
    };
    state.temples.push(o);
  }

  if(sel.face){
    const fo=state.faces.find(x=>x.name===sel.face);
    if(fo) state.selFace=fo;
  }
  if(sel.temples){
    const to=state.temples.find(x=>x.name===sel.temples);
    if(to) state.selTemples=to;
  }

  rebuildAllGalleries();
  redraw();
}

/* Drive fetch helpers */
function apiListURL(folderId){
  const base="https://www.googleapis.com/drive/v3/files";
  const q=new URLSearchParams({
    key:DRIVE.API_KEY,
    q:`'${folderId}' in parents and trashed=false`,
    fields:"files(id,name,mimeType,modifiedTime)",
    pageSize:1000,
    orderBy:"name"
  }).toString();
  return base+"?"+q;
}
function apiDownloadURL(id){
  return "https://drive.google.com/uc?export=download&id="+encodeURIComponent(id);
}
function proxyURL(u){
  return DRIVE.WORKER_URL+"?u="+encodeURIComponent(u);
}

async function fetchJSONfallback(url){
  try{
    const r=await fetch(proxyURL(url),{mode:"cors",headers:{"Content-Type":"application/json"},cache:"no-store"});
    if(!r.ok) throw new Error("proxy json "+r.status);
    return await r.json();
  }catch(e){
    const r2=await fetch(url,{mode:"cors",cache:"no-store"});
    if(!r2.ok) throw new Error("direct json "+r2.status);
    return await r2.json();
  }
}
async function fetchBLOBfallback(url){
  try{
    const r=await fetch(proxyURL(url),{mode:"cors",cache:"no-store"});
    if(!r.ok) throw new Error("proxy blob "+r.status);
    return await r.blob();
  }catch(e){
    const r2=await fetch(url,{mode:"cors",cache:"no-store"});
    if(!r2.ok) throw new Error("direct blob "+r2.status);
    return await r2.blob();
  }
}

/* intégrer un fichier Drive */
async function integrateDriveFile(type,name,blob,driveTs){
  const baseImg=await imgFromBlob(blob);

  const {thumbDataURL,textColor}=makeThumbInfo(baseImg);

  let entry;
  if(type==="face"){
    const proc=removeBackgroundAuto(baseImg,state.tol);
    entry={
      name,
      img:baseImg,
      proc,
      modified:driveTs||null,
      thumbDataURL,
      textColor
    };
    const i=state.faces.findIndex(x=>x.name===name);
    if(i>=0){ state.faces[i]=entry; } else { state.faces.push(entry); }
    proc.onload=()=>redraw();
    if(!state.selFace){ state.selFace=entry; }
  }else{
    entry={
      name,
      img:baseImg,
      modified:driveTs||null,
      thumbDataURL,
      textColor
    };
    const j=state.temples.findIndex(x=>x.name===name);
    if(j>=0){ state.temples[j]=entry; } else { state.temples.push(entry); }
    if(!state.selTemples){ state.selTemples=entry; }
  }

  await putImageRecord(type,name,blob,driveTs,thumbDataURL,textColor).catch(()=>{});
  await persistLists().catch(()=>{});

  rebuildAllGalleries();
  redraw();
}

/* sync dossiers Drive */
async function syncFolder(type,folderId){
  let listing;
  try{
    listing=await fetchJSONfallback(apiListURL(folderId));
  }catch(e){
    console.warn("Drive listing fail",type,e);
    return;
  }

  const imgs=(listing.files||[]).filter(f=>(f.mimeType||'').startsWith('image/'));

  for(const f of imgs){
    const name=f.name || (f.id+".png");
    const driveTs=f.modifiedTime || null;
    const dl=apiDownloadURL(f.id);

    let blob;
    try{
      blob=await fetchBLOBfallback(dl);
    }catch(err){
      console.warn("Drive blob fail",name,err);
      continue;
    }

    await integrateDriveFile(type,name,blob,driveTs);
  }
}

/* Zoom molette */
const MIN_ZOOM=1.0;
const MAX_ZOOM=2.5;
viewer.addEventListener('wheel',e=>{
  e.preventDefault();
  state.zoomScale += (e.deltaY<0 ? 0.1 : -0.1);
  if(state.zoomScale<MIN_ZOOM) state.zoomScale=MIN_ZOOM;
  if(state.zoomScale>MAX_ZOOM) state.zoomScale=MAX_ZOOM;
  cvWrap.style.transform=`scale(${state.zoomScale})`;
},{passive:false});

/* BOOT */
(async function boot(){
  try{
    await openDB().catch(()=>{});
    await reloadFromIndexedDB().catch(()=>{});
    await syncFolder('temples',DRIVE.TEMPLES_FOLDER_ID);
    await syncFolder('face',   DRIVE.FACES_FOLDER_ID);
    driveNote.textContent="";
  }catch(e){
    console.error("BOOT ERROR",e);
    driveNote.textContent="";
  }
})();
</script>

<div id="toast" class="toast">⭐ Ajouté aux favoris</div>

</body>
</html>
