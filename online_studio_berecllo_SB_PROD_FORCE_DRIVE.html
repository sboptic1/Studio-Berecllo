<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Studio Berecllo — By S.B</title>

<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E">

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">

<style>
:root{
  --headerH:95px;
  --border:#e6e8ee;
  --gold1:#fff4c2;
  --gold2:#f1d98a;
  --gold3:#e0c066;
  --gold4:#b8943e;
  --gold5:#f9e9ad;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:#f6f7fa;
  color:#111;
  font:15px/1.6 'Helvetica Neue',Helvetica,Arial,sans-serif;
}

/* HEADER */
.header-wrap{
  position:fixed;
  inset:0 0 auto 0;
  height:var(--headerH);
  background:#fff;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  z-index:100;
  box-shadow:0 8px 24px rgba(0,0,0,.05);
}
.brand{
  display:flex;
  align-items:center;
  height:100%;
}
.brand a{
  display:flex;
  align-items:center;
  height:100%;
  text-decoration:none;
}
.brand svg{
  height:60px;
  width:auto;
  display:block;
}
.headerTexts{
  text-align:right;
}
.title{
  font:300 22px/1 'Helvetica Neue',sans-serif;
  letter-spacing:.06em;
  color:#111;
  margin:0;
}
.subTitleSmall{
  font-size:12px;
  font-weight:500;
  color:#6b7280;
  letter-spacing:.08em;
  text-transform:uppercase;
  margin:4px 0 0 0;
}

/* PAGE LAYOUT */
.page{
  padding-top:calc(var(--headerH) + 20px);
}
.wrap{
  max-width:1760px;
  margin:0 auto;
  padding:0 24px;
}
.grid{
  display:grid;
  grid-template-columns:minmax(0,1fr) 420px;
  gap:32px;
}
@media(max-width:1200px){
  .grid{grid-template-columns:1fr;}
}

/* CARD PRINCIPALE */
.card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:20px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
  display:flex;
  flex-direction:column;
}
.viewer{
  position:relative;
  aspect-ratio:2048/1265;
  width:100%;
  border-radius:20px 20px 0 0;
  overflow:hidden;
  background:#eef2f7;
  display:flex;
  align-items:center;
  justify-content:center;
  touch-action:none;
}
#cvWrap{
  position:relative;
  width:100%;
  height:100%;
  transform-origin:center center;
  display:flex;
  align-items:center;
  justify-content:center;
}
canvas#cv{
  width:100%;
  height:100%;
  display:block;
  background:#eef2f7;
}
.model-label{
  position:absolute;
  left:50%;
  bottom:20px;
  transform:translateX(-50%);
  padding:12px 18px;
  border-radius:14px;
  background:rgba(255,255,255,.96);
  border:1px solid rgba(0,0,0,.1);
  backdrop-filter:blur(6px);
  font:300 21px/1.2 'Helvetica Neue',sans-serif;
  letter-spacing:.12em;
  color:#0b0d10;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
  white-space:nowrap;
  max-width:90%;
  overflow:hidden;
  text-overflow:ellipsis;
  text-align:center;
}

/* TOOLBAR */
.toolbar{
  border-top:1px solid var(--border);
  padding:16px 20px;
  display:flex;
  justify-content:flex-end;
  gap:12px;
  flex-wrap:wrap;
}
.btn3d{
  cursor:pointer;
  border:0;
  border-radius:12px;
  padding:12px 18px;
  font:600 15px/1.1 'Helvetica Neue',sans-serif;
  color:#111;
  background:#fff;
  position:relative;
  isolation:isolate;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.9),
             0 6px 16px rgba(0,0,0,.08);
  transition:transform .1s,box-shadow .15s;
}
.btn3d::before{
  content:'';
  position:absolute;
  inset:0;
  border-radius:12px;
  padding:2px;
  background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  pointer-events:none;
}
.btn3d:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 26px rgba(0,0,0,.15);
}

/* PANNEAUX CÔTÉ DROIT */
.side{
  display:flex;
  flex-direction:column;
  gap:22px;
}
.panel{
  background:#fff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px 16px 20px;
  box-shadow:0 12px 30px rgba(0,0,0,.06);
}
.panelHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.panelHeader h2{
  margin:0;
  font:600 18px/1 'Montserrat',sans-serif;
  color:#111;
  display:flex;
  align-items:center;
  gap:10px;
}

/* GALERIES */
.gal{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:18px;
}
@media(min-width:1400px){
  .gal{grid-template-columns:repeat(4,1fr);}
}
@media(max-width:600px){
  .gal{grid-template-columns:repeat(2,1fr);}
}

/* VIGNETTE = cadre + image carrée interne */
.thumb{
  position:relative;
  border-radius:12px;
  overflow:hidden;
  width:100%;
  aspect-ratio:1/1;
  cursor:pointer;
  box-shadow:
    0 6px 14px rgba(0,0,0,.06),
    inset 0 1px 0 rgba(255,255,255,.9);
  background:#fafafa;
  transition:all .2s;
  display:flex;
  align-items:center;
  justify-content:center;
}
.thumb:hover{
  transform:translateY(-2px);
  filter:brightness(1.05);
}
.thumbInnerBorder{
  position:absolute;
  inset:0;
  border-radius:12px;
  pointer-events:none;
  box-shadow:0 0 0 0 rgba(0,0,0,0);
  transition:box-shadow .2s;
}
.thumb[aria-selected="true"] .thumbInnerBorder{
  /* bord doré "sélectionné" */
  box-shadow:
    0 0 10px rgba(255,215,0,.5),
    0 0 0 3px rgba(224,192,102,.9),
    0 6px 14px rgba(0,0,0,.06);
}

/* zone image miniature réelle */
.thumbImg{
  position:absolute;
  inset:0;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
}

/* label + croix */
.thumbLabel{
  position:absolute;
  left:10px;
  bottom:10px;
  right:10px;
  font:600 15px/1.3 'Montserrat',sans-serif;
  letter-spacing:.06em;
  text-align:left;
  word-break:break-word;
  z-index:2;
  text-shadow:0 2px 4px rgba(0,0,0,.6);
  color:#000;
}
.thumbClose{
  position:absolute;
  top:8px;
  right:8px;
  width:24px;
  height:24px;
  border-radius:6px;
  background:rgba(0,0,0,.55);
  color:#fff;
  font-size:13px;
  font-family:'Helvetica Neue',sans-serif;
  line-height:24px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  z-index:3;
  box-shadow:0 2px 4px rgba(0,0,0,.45);
  user-select:none;
}

/* NOTE (debug) masquée */
.note{
  margin:10px 0 20px 20px;
  font:600 12px 'Montserrat',sans-serif;
  color:#8a8f9a;
  visibility:hidden;
}

/* TOAST */
.toast{
  position:fixed;
  left:50%;
  bottom:40px;
  transform:translateX(-50%);
  background:rgba(255,255,255,.95);
  border:1px solid rgba(0,0,0,.1);
  border-radius:12px;
  padding:12px 22px;
  font:600 15px 'Montserrat',sans-serif;
  color:#000;
  box-shadow:0 4px 20px rgba(0,0,0,.15);
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
}
.toast.show{opacity:1}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header-wrap">
  <div class="brand">
    <a href="https://berecllo.fr/" target="_blank" title="Visiter le site Berecllo" aria-label="Berecllo">
      <!-- Logo inline forçé en NOIR -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 350 173.66" width="200" height="60" aria-hidden="true">
        <defs>
          <style>
            .cls-1 { stroke: #000; stroke-miterlimit:10; stroke-width:.37px; }
            .cls-1, .cls-2 { fill:#000; }
            .cls-2 { stroke-width:0px; }
          </style>
        </defs>
        <g>
          <rect class="cls-2" y="133.47" width="350" height="2.39"/>
          <g>
            <path class="cls-2" d="M126.86,69.66c-7.58,0-14.09,4.5-19.54,13.49-4.85,7.92-7.28,15.87-7.28,23.86,0,3.96.7,6.83,2.1,8.62,1.4,1.79,3.42,2.69,6.08,2.69,8.89,0,22.63-11.99,23.52-13.05.89-1.06.7-1.86.31-2.34-.39-.48-1.35-.65-2.16-.12-.8.53-8.34,5.9-10.81,7.05-1.83.86-3.51,1.29-5.04,1.29-1.61,0-2.83-.52-3.67-1.57-.84-1.05-1.26-2.89-1.26-5.54,0-1.83.17-3.75.5-5.77,7.09-3.21,11.72-5.43,13.89-6.66,4.33-2.54,7.33-4.98,9.01-7.33,1.68-2.35,2.52-4.74,2.52-7.17s-.7-4.13-2.1-5.46c-1.4-1.32-3.43-1.99-6.08-1.99Z"/>
            <path class="cls-2" d="M178.41,74.64c.73-.71,1.09-1.57,1.09-2.57s-.38-1.82-1.12-2.55c-.75-.73-1.68-1.09-2.8-1.09-1.54,0-3.44,1.01-5.73,3.04-4.75,4.24-9.01,9.33-12.79,15.29l2.44-10.07c.49-2.1.74-3.39.74-3.88s-.2-.89-.59-1.2c-.39-.32-.92-.48-1.59-.48-1.9,0-4.61,1.02-8.2,2.88-3.94,2.04-9.49,7.37-9.95,8-.52.72-.39,1.26.1,1.63.49.37,1.34.33,1.82-.08.52-.41,4.16-3.86,5.31-4.63,1.16-.76,2.02-1.15,2.58-1.15.82,0,1.23.45,1.23,1.34,0,.41-.17,1.44-.5,3.08-1.42,6.64-3.08,13.66-4.98,21.05l-3.92,15.06h8.34l2.53-10.86c1.68-7.28,2.94-11.91,3.76-13.91.82-2,2.27-4.34,4.34-7.03,2.07-2.69,3.97-4.69,5.71-5.99,1.74-1.31,3.98-2.43,6.74-3.36,2.91-.97,4.73-1.81,5.46-2.52Z"/>
            <path class="cls-2" d="M246.18,71.22c-1.42-1.04-3.51-1.57-6.27-1.57-4.4,0-8.36,1.29-11.87,3.86-4.48,3.32-8.29,8.1-11.42,14.34-3.13,6.23-4.7,12.3-4.7,18.2,0,3.55.74,6.48,2.21,8.79,1.47,2.31,3.84,3.51,7.09,3.47,9.66-.11,21.23-10.36,22.71-11.69,1.48-1.33,1.26-2.65.98-3.04-.41-.56-1.42-.9-2.26-.39-1.68,1.01-11.36,9.02-15.72,9.02-1.83,0-3.25-.74-4.26-2.24-1.38-1.94-2.07-4.68-2.07-8.22,0-4.81.82-9.6,2.46-14.37,1.64-4.77,3.37-7.99,5.18-9.64,1.81-1.66,3.63-2.49,5.46-2.49,1.42,0,3.19.63,5.32,1.9,2.05,1.19,3.73,1.79,5.04,1.79s2.39-.36,3.14-1.09c.75-.73,1.12-1.67,1.12-2.83,0-1.49-.71-2.76-2.13-3.81Z"/>
            <path class="cls-2" d="M339.05,73.97c-2.43-2.91-5.47-4.37-9.13-4.37-8.4,0-15.42,4.12-21.06,12.38-4.48,6.64-6.72,13.89-6.72,21.73,0,1.43.14,2.75.38,3.99-5.75,2.91-10.05,4.11-14,4.77-1.85.31-1.58-1.71-1.3-3.2.11-.59,1.57-7.59,4.72-20.99l6.37-26.74c2.25-9.61,3.87-16.04,4.86-19.3,1-3.26,2.11-5.4,3.34-6.41.89-.72,2.21-1.08,3.94-1.08s7.13.91,8.57.91c2.29,0,5.83-2.01,5.83-5.67,0-4.12-3.11-5.99-6.13-5.99-5.35,0-7.54,4.16-12.36,7.04-4.82,2.88-8.55,6.93-11.18,12.14-1.7,3.45-3.8,10.23-6.31,20.35l-6.88,28.01c-1.46,5.95-2.52,10.77-3.17,14.47-7.41,4.16-12.53,5.7-17.18,6.47-1.85.31-1.58-1.71-1.3-3.2.11-.59,1.57-7.59,4.72-20.99l6.37-26.74c2.25-9.61,3.87-16.04,4.86-19.3,1-3.26,2.11-5.4,3.34-6.41.89-.72,2.21-1.08,3.94-1.08s7.13.91,8.57.91c2.29,0,5.83-2.01,5.83-5.67,0-4.12-3.11-5.99-6.13-5.99-5.35,0-7.54,4.16-12.36,7.04-4.82,2.88-8.55,6.93-11.18,12.14-1.7,3.45-3.8,10.23-6.31,20.35l-6.88,28.01c-2.64,10.72-3.95,17.78-3.95,21.19,0,1.74.43,3.12,1.28,4.12.85,1,1.94,1.51,3.26,1.5,7.94-.05,16.69-4.55,22.47-7.67-.08.79-.12,1.48-.12,2.06,0,1.74.43,3.12,1.28,4.12.85,1,1.94,1.51,3.26,1.5,7.36-.05,15.42-3.92,21.16-6.97.55,1.13,1.24,2.15,2.08,3.05,2.44,2.61,5.66,3.92,9.66,3.92,6.49,0,12.66-3.29,18.48-9.88,5.82-6.59,8.73-14.03,8.73-22.32,0-5.19-1.21-9.24-3.64-12.15Z"/>
          </g>
        </g>
      </svg>
    </a>
  </div>
  <div class="headerTexts">
    <h1 class="title">Studio Berecllo — By&nbsp;S.B</h1>
    <div class="subTitleSmall">Configuration monture • rendu photo-réaliste</div>
  </div>
</header>

<!-- PAGE -->
<div class="page">
  <div class="wrap">
    <div class="grid">

      <!-- ZONE CENTRALE -->
      <div class="card">
        <div class="viewer" id="viewer">
          <div id="cvWrap">
            <canvas id="cv" width="2048" height="1265"></canvas>
          </div>
          <div class="model-label" id="modelLabel">—</div>
        </div>
        <div class="toolbar">
          <button class="btn3d" id="btnFav">❤ Favoris</button>
          <button class="btn3d" id="btnShare">⇪ Partager</button>
          <button class="btn3d" id="btnExport">⬇ Exporter</button>
        </div>
        <p class="note" id="driveNote">...</p>
      </div>

      <!-- COLONNE DROITE -->
      <aside class="side">
        <div class="panel">
          <div class="panelHeader"><h2>Faces</h2></div>
          <div id="galFaces" class="gal"></div>
        </div>

        <div class="panel">
          <div class="panelHeader"><h2>Branches</h2></div>
          <div id="galTemples" class="gal"></div>
        </div>

        <div class="panel">
          <div class="panelHeader"><h2>Favoris</h2></div>
          <div id="galFavs" class="gal"></div>
        </div>
      </aside>

    </div>
  </div>
</div>

<div id="toast" class="toast">⭐ Ajouté aux favoris</div>

<script>
/* CONFIG DRIVE */
const DRIVE = {
  API_KEY: "AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",
  FACES_FOLDER_ID:   "1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",
  TEMPLES_FOLDER_ID: "1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",
  WORKER_URL: "https://berecllo-proxy1.sb-optic1.workers.dev"
};

/* DOM */
const cv       = document.getElementById('cv');
const ctx      = cv.getContext('2d',{willReadFrequently:true});
const cvWrap   = document.getElementById('cvWrap');

const modelLabel = document.getElementById('modelLabel');

const viewer     = document.getElementById('viewer');
const galFaces   = document.getElementById('galFaces');
const galTemples = document.getElementById('galTemples');
const galFavs    = document.getElementById('galFavs');

const btnFav     = document.getElementById('btnFav');
const btnShare   = document.getElementById('btnShare');
const btnExport  = document.getElementById('btnExport');

const driveNote  = document.getElementById('driveNote');
const toast      = document.getElementById('toast');

/* STATE */
const state = {
  faces: [],       // {name,img,proc,modified,thumbDataURL,textColor}
  temples: [],     // {name,img,modified,thumbDataURL,textColor}
  selFace: null,
  selTemples: null,
  favs: [],
  tol: 60,
  zoomScale: 1.0,
  dbReady:false,
  dbFailed:false
};

/* IndexedDB */
let db;
const DB_NAME='berecllo-store';
const DB_VER=4; // bump to force structure refresh if needed

function openDB(){
  return new Promise((resolve,reject)=>{
    try{
      const req=indexedDB.open(DB_NAME,DB_VER);
      req.onupgradeneeded=e=>{
        const d=e.target.result;
        if(!d.objectStoreNames.contains('images')){
          d.createObjectStore('images',{keyPath:'id'});
        }
        if(!d.objectStoreNames.contains('meta')){
          d.createObjectStore('meta',{keyPath:'key'});
        }
      };
      req.onsuccess=()=>{
        db=req.result;
        state.dbReady=true;
        resolve(db);
      };
      req.onerror=()=>{
        state.dbFailed=true;
        reject(req.error||new Error("IndexedDB open error"));
      };
    }catch(err){
      state.dbFailed=true;
      reject(err);
    }
  });
}
function idFor(type,name){ return `${type}|${name}`; }

function putImageRecord(type,name,blob,modified,thumbDataURL,textColor){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readwrite');
    tx.objectStore('images').put({
      id:idFor(type,name),
      name,
      type,
      blob,
      modified:modified||null,
      thumbDataURL:thumbDataURL||null,
      textColor:textColor||null
    });
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("putImageRecord fail"));
  });
}
function deleteImageRecord(type,name){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readwrite');
    tx.objectStore('images').delete(idFor(type,name));
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("deleteImageRecord fail"));
  });
}
function getAllImages(){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve([]);
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('images','readonly');
    const r=tx.objectStore('images').getAll();
    r.onsuccess=()=>resolve(r.result||[]);
    r.onerror =()=>reject(r.error||new Error("getAllImages fail"));
  });
}
function saveMeta(key,val){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve();
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('meta','readwrite');
    tx.objectStore('meta').put({key,value:val});
    tx.oncomplete=()=>resolve();
    tx.onerror =()=>reject(tx.error||new Error("saveMeta fail"));
  });
}
function loadMeta(key){
  if(state.dbFailed||!state.dbReady||!db) return Promise.resolve(null);
  return new Promise((resolve,reject)=>{
    const tx=db.transaction('meta','readonly');
    const r=tx.objectStore('meta').get(key);
    r.onsuccess=()=>resolve(r.result?r.result.value:null);
    r.onerror =()=>reject(r.error||new Error("loadMeta fail"));
  });
}

/* utils image */
function imgFromBlob(blob){
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>res(img);
    img.onerror=(e)=>rej(e);
    img.src=URL.createObjectURL(blob);
  });
}

/* détourage face (fond transparent) */
function removeBackgroundAuto(img,tol){
  const w=img.naturalWidth||img.width;
  const h=img.naturalHeight||img.height;
  const c=document.createElement('canvas');
  c.width=w; c.height=h;
  const x=c.getContext('2d',{willReadFrequently:true});
  x.drawImage(img,0,0);
  const data=x.getImageData(0,0,w,h);
  const d=data.data;

  const margin=Math.floor(Math.min(w,h)*0.03);
  const steps=10;
  let r=0,g=0,b=0,n=0;
  function pick(sx,sy){
    const o=(sy*w+sx)*4;
    r+=d[o]; g+=d[o+1]; b+=d[o+2]; n++;
  }
  for(let i=0;i<=steps;i++){
    const t=Math.floor(i*(w-1)/steps);
    const u=Math.floor(i*(h-1)/steps);
    pick(t,margin); pick(t,h-1-margin);
    pick(margin,u); pick(w-1-margin,u);
  }
  r/=n; g/=n; b/=n;

  for(let i=0;i<d.length;i+=4){
    const dr=d[i]-r, dg=d[i+1]-g, db=d[i+2]-b;
    const dist=Math.sqrt(dr*dr+dg*dg+db*db);
    if(dist<tol){
      d[i+3]=0;
    }
  }
  x.putImageData(data,0,0);
  const out=new Image();
  out.src=c.toDataURL('image/png');
  return out;
}

/* miniature carrée = copie réelle + choix texte lisible */
function makeThumbInfo(img){
  const SIZE=200;
  const c=document.createElement('canvas');
  c.width=SIZE;
  c.height=SIZE;
  const x=c.getContext('2d');

  const iw=img.naturalWidth||img.width;
  const ih=img.naturalHeight||img.height;
  const aspect = iw/ih;

  // crop central pour remplir un carré
  let sx,sy,sw,sh;
  if(aspect>1){
    // image plus large que haute -> on coupe les côtés
    sh=ih;
    sw=ih;
    sx=(iw-sw)/2;
    sy=0;
  }else{
    // image plus haute que large -> on coupe haut/bas
    sw=iw;
    sh=iw;
    sx=0;
    sy=(ih-sh)/2;
  }

  x.drawImage(img,sx,sy,sw,sh,0,0,SIZE,SIZE);

  // moyenne luminance -> blanc ou noir
  const data=x.getImageData(0,0,SIZE,SIZE).data;
  let rr=0,gg=0,bb=0,n=0;
  for(let i=0;i<data.length;i+=4){
    rr+=data[i];
    gg+=data[i+1];
    bb+=data[i+2];
    n++;
  }
  rr/=n; gg/=n; bb/=n;
  const lum = 0.299*rr + 0.587*gg + 0.114*bb;
  const textColor = lum < 140 ? '#fff' : '#000';

  return {
    thumbDataURL: c.toDataURL('image/jpeg',0.8),
    textColor
  };
}

/* labels */
function faceLabel(n){
  return n.replace(/\.[^.]+$/,'').toUpperCase();
}
function templesLabel(n){
  return n.replace(/\.[^.]+$/,'').toLowerCase();
}

/* rendu principal */
function updateLabel(){
  const f=state.selFace    ? faceLabel(state.selFace.name)     : '';
  const t=state.selTemples ? templesLabel(state.selTemples.name): '';
  modelLabel.textContent = (f && t) ? `${f} - ${t}` : (f || t || '—');
}
function redraw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(state.selTemples?.img){
    ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height);
  }
  if(state.selFace?.proc){
    ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height);
  }
  updateLabel();
  persistSelection().catch(()=>{});
}

/* sélection / suppression */
function selectAndRedraw(isFace,obj){
  if(isFace) state.selFace=obj;
  else       state.selTemples=obj;
  redraw();
  rebuildAllGalleries();
}

async function removeVariant(isFace,name){
  const list = isFace ? state.faces : state.temples;
  const idx=list.findIndex(x=>x.name===name);
  if(idx>=0){
    if(isFace && state.selFace && state.selFace.name===name){
      state.selFace=null;
    }
    if(!isFace && state.selTemples && state.selTemples.name===name){
      state.selTemples=null;
    }
    list.splice(idx,1);
  }
  const type=isFace?'face':'temples';
  await deleteImageRecord(type,name).catch(()=>{});

  await persistLists().catch(()=>{});
  redraw();
  rebuildAllGalleries();
}

/* Vignettes */
function buildThumbEl(isFace,obj){
  const wrap=document.createElement('div');
  wrap.className='thumb';
  wrap.setAttribute('aria-selected',
    (isFace ? state.selFace===obj : state.selTemples===obj) ? 'true':'false'
  );

  const border=document.createElement('div');
  border.className='thumbInnerBorder';
  wrap.appendChild(border);

  const imgDiv=document.createElement('div');
  imgDiv.className='thumbImg';
  if(obj.thumbDataURL){
    imgDiv.style.backgroundImage=`url("${obj.thumbDataURL}")`;
  }else{
    imgDiv.style.backgroundColor='#ddd';
  }
  wrap.appendChild(imgDiv);

  const lbl=document.createElement('div');
  lbl.className='thumbLabel';
  lbl.style.color = obj.textColor || '#000';
  lbl.textContent = isFace? faceLabel(obj.name) : templesLabel(obj.name);
  wrap.appendChild(lbl);

  const close=document.createElement('div');
  close.className='thumbClose';
  close.textContent='✕';
  close.addEventListener('click',e=>{
    e.stopPropagation();
    removeVariant(isFace,obj.name);
  });
  wrap.appendChild(close);

  wrap.addEventListener('click',()=>{
    selectAndRedraw(isFace,obj);
  });

  return wrap;
}

function rebuildGallery(dom,list,isFace){
  dom.innerHTML='';
  list.forEach(o=>{
    dom.appendChild(buildThumbEl(isFace,o));
  });
}
function renderFavs(){
  galFavs.innerHTML='';
  state.favs.forEach(fv=>{
    const fObj=state.faces.find(x=>x.name===fv.face);
    // on affiche la vignette favoris à partir de la face
    const wrap=document.createElement('div');
    wrap.className='thumb';
    wrap.setAttribute('aria-selected','false');

    const border=document.createElement('div');
    border.className='thumbInnerBorder';
    wrap.appendChild(border);

    const imgDiv=document.createElement('div');
    imgDiv.className='thumbImg';
    if(fObj && fObj.thumbDataURL){
      imgDiv.style.backgroundImage=`url("${fObj.thumbDataURL}")`;
    }else{
      imgDiv.style.backgroundColor='#ccc';
    }
    wrap.appendChild(imgDiv);

    const lbl=document.createElement('div');
    lbl.className='thumbLabel';
    lbl.style.color = fObj?.textColor || '#000';
    lbl.textContent = fv.label;
    wrap.appendChild(lbl);

    wrap.addEventListener('click',()=>{
      const faceObj   = state.faces.find(x=>x.name===fv.face);
      const templObj  = state.temples.find(x=>x.name===fv.temples);
      if(faceObj)  state.selFace=faceObj;
      if(templObj) state.selTemples=templObj;
      redraw();
      rebuildAllGalleries();
    });

    galFavs.appendChild(wrap);
  });
}
function rebuildAllGalleries(){
  rebuildGallery(galFaces,state.faces,true);
  rebuildGallery(galTemples,state.temples,false);
  renderFavs();
}

/* Favoris / Export / Share */
function slugifyForFilename(s){
  return (s||'berecllo')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^\w\- ]+/g,'')
    .replace(/\s+/g,'_')
    .replace(/_+/g,'_')
    .replace(/^_+|_+$/g,'');
}
function toastMsg(t){
  toast.textContent=t;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1400);
}

btnExport.onclick = ()=>cv.toBlob(b=>{
  const base=slugifyForFilename(modelLabel.textContent||'berecllo');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(b);
  a.download=base+'.png';
  a.click();
});
btnShare.onclick = ()=>cv.toBlob(async b=>{
  const base=slugifyForFilename(modelLabel.textContent||'berecllo');
  const f=new File([b],base+'.png',{type:'image/png'});
  if(navigator.canShare && navigator.canShare({files:[f]})){
    try{
      await navigator.share({
        files:[f],
        title:'Berecllo',
        text:modelLabel.textContent||''
      });
    }catch(e){}
  }
});
btnFav.onclick = async ()=>{
  if(!state.selFace||!state.selTemples) return;
  const label=modelLabel.textContent;
  if(state.favs.find(x=>x.face===state.selFace.name && x.temples===state.selTemples.name)) return;
  state.favs.unshift({
    face:state.selFace.name,
    temples:state.selTemples.name,
    label
  });
  if(state.favs.length>5) state.favs.pop();
  await saveMeta('favs',state.favs).catch(()=>{});
  renderFavs();
  toastMsg('⭐ Ajouté aux favoris');
};

/* Persistance de sélection/lists */
async function persistLists(){
  const fNames=state.faces.map(x=>x.name);
  const tNames=state.temples.map(x=>x.name);
  await saveMeta('facesNames',fNames).catch(()=>{});
  await saveMeta('templesNames',tNames).catch(()=>{});
}
async function persistSelection(){
  await saveMeta('selection',{
    face:state.selFace?.name||null,
    temples:state.selTemples?.name||null
  }).catch(()=>{});
}

/* reload à partir du cache local pour affichage immédiat */
async function reloadFromIndexedDB(){
  const arr=await getAllImages().catch(()=>[]);
  const facesNames   = await loadMeta('facesNames').catch(()=>null) || [];
  const templesNames = await loadMeta('templesNames').catch(()=>null)|| [];
  const sel          = await loadMeta('selection').catch(()=>null) || {face:null,temples:null};
  const favs         = await loadMeta('favs').catch(()=>[]) || [];

  state.favs = favs.slice(0,5);

  // index
  const map={};
  for(const rec of arr){
    map[idFor(rec.type,rec.name)] = rec;
  }

  // faces
  const allFacesNames=[...new Set([...facesNames,...arr.filter(x=>x.type==='face').map(x=>x.name)])];
  for(const nm of allFacesNames){
    const rec=map[idFor('face',nm)];
    if(!rec) continue;
    const img=await imgFromBlob(rec.blob);
    // si pas thumbDataURL en base -> on la crée maintenant
    let thumbDataURL=rec.thumbDataURL;
    let textColor=rec.textColor;
    if(!thumbDataURL || !textColor){
      const tinfo=makeThumbInfo(img);
      thumbDataURL=tinfo.thumbDataURL;
      textColor=tinfo.textColor;
      // on pousse back en DB pour persister
      await putImageRecord('face',nm,rec.blob,rec.modified,thumbDataURL,textColor).catch(()=>{});
    }
    // détourage
    const proc=removeBackgroundAuto(img,state.tol);

    const o={
      name:nm,
      img,
      proc,
      modified:rec.modified||null,
      thumbDataURL,
      textColor
    };
    state.faces.push(o);
    proc.onload=()=>redraw();
  }

  // temples
  const allTemplNames=[...new Set([...templesNames,...arr.filter(x=>x.type==='temples').map(x=>x.name)])];
  for(const nm of allTemplNames){
    const rec=map[idFor('temples',nm)];
    if(!rec) continue;
    const img=await imgFromBlob(rec.blob);
    let thumbDataURL=rec.thumbDataURL;
    let textColor=rec.textColor;
    if(!thumbDataURL || !textColor){
      const tinfo=makeThumbInfo(img);
      thumbDataURL=tinfo.thumbDataURL;
      textColor=tinfo.textColor;
      await putImageRecord('temples',nm,rec.blob,rec.modified,thumbDataURL,textColor).catch(()=>{});
    }
    const o={
      name:nm,
      img,
      modified:rec.modified||null,
      thumbDataURL,
      textColor
    };
    state.temples.push(o);
  }

  // restaure sélection
  if(sel.face){
    const fo=state.faces.find(x=>x.name===sel.face);
    if(fo) state.selFace=fo;
  }
  if(sel.temples){
    const to=state.temples.find(x=>x.name===sel.temples);
    if(to) state.selTemples=to;
  }

  rebuildAllGalleries();
  redraw();
}

/* Fetch vers Drive */
function apiListURL(folderId){
  const base="https://www.googleapis.com/drive/v3/files";
  const q=new URLSearchParams({
    key:DRIVE.API_KEY,
    q:`'${folderId}' in parents and trashed=false`,
    fields:"files(id,name,mimeType,modifiedTime)",
    pageSize:1000,
    orderBy:"name"
  }).toString();
  return base+"?"+q;
}
function apiDownloadURL(id){
  return "https://drive.google.com/uc?export=download&id="+encodeURIComponent(id);
}
function proxyURL(u){
  return DRIVE.WORKER_URL+"?u="+encodeURIComponent(u);
}

async function fetchJSONfallback(url){
  // essaie proxy, puis direct
  try{
    const r=await fetch(proxyURL(url),{mode:"cors",headers:{"Content-Type":"application/json"},cache:"no-store"});
    if(!r.ok) throw new Error("proxy json "+r.status);
    return await r.json();
  }catch(e){
    const r2=await fetch(url,{mode:"cors",cache:"no-store"});
    if(!r2.ok) throw new Error("direct json "+r2.status);
    return await r2.json();
  }
}
async function fetchBLOBfallback(url){
  try{
    const r=await fetch(proxyURL(url),{mode:"cors",cache:"no-store"});
    if(!r.ok) throw new Error("proxy blob "+r.status);
    return await r.blob();
  }catch(e){
    const r2=await fetch(url,{mode:"cors",cache:"no-store"});
    if(!r2.ok) throw new Error("direct blob "+r2.status);
    return await r2.blob();
  }
}

/* Intégrer un fichier Drive dans l'état + DB + re-render immédiat */
async function integrateDriveFile(type,name,blob,driveTs){
  const baseImg=await imgFromBlob(blob);

  // miniature carrée à partir de l'image réelle
  const {thumbDataURL,textColor}=makeThumbInfo(baseImg);

  let entry;
  if(type==="face"){
    const proc=removeBackgroundAuto(baseImg,state.tol);
    entry={
      name,
      img:baseImg,
      proc,
      modified:driveTs||null,
      thumbDataURL,
      textColor
    };
    // remplace si existe déjà
    const i=state.faces.findIndex(x=>x.name===name);
    if(i>=0){ state.faces[i]=entry; } else { state.faces.push(entry); }
    proc.onload=()=>redraw();
    if(!state.selFace){ state.selFace=entry; }
  }else{
    entry={
      name,
      img:baseImg,
      modified:driveTs||null,
      thumbDataURL,
      textColor
    };
    const j=state.temples.findIndex(x=>x.name===name);
    if(j>=0){ state.temples[j]=entry; } else { state.temples.push(entry); }
    if(!state.selTemples){ state.selTemples=entry; }
  }

  // sauve dans IndexedDB (avec thumb et textColor)
  await putImageRecord(type,name,blob,driveTs,thumbDataURL,textColor).catch(()=>{});
  await persistLists().catch(()=>{});

  // maj UI immédiate
  rebuildAllGalleries();
  redraw();
}

/* Sync un dossier Drive (faces ou branches) */
async function syncFolder(type,folderId){
  let listing;
  try{
    listing=await fetchJSONfallback(apiListURL(folderId));
  }catch(e){
    console.warn("Drive listing fail",type,e);
    return; // pas de crash => on garde juste le cache local
  }

  const imgs=(listing.files||[]).filter(f=>(f.mimeType||'').startsWith('image/'));

  for(const f of imgs){
    const name=f.name || (f.id+".png");
    const driveTs=f.modifiedTime || null;
    const dl=apiDownloadURL(f.id);

    let blob;
    try{
      blob=await fetchBLOBfallback(dl);
    }catch(err){
      console.warn("Drive blob fail",name,err);
      continue;
    }

    await integrateDriveFile(type,name,blob,driveTs);
  }
}

/* Zoom molette local dans le cadre */
const MIN_ZOOM=1.0;
const MAX_ZOOM=2.5;
viewer.addEventListener('wheel',e=>{
  e.preventDefault();
  state.zoomScale += (e.deltaY<0 ? 0.1 : -0.1);
  if(state.zoomScale<MIN_ZOOM) state.zoomScale=MIN_ZOOM;
  if(state.zoomScale>MAX_ZOOM) state.zoomScale=MAX_ZOOM;
  cvWrap.style.transform=`scale(${state.zoomScale})`;
},{passive:false});

/* BOOT */
(async function boot(){
  try{
    await openDB().catch(()=>{});
    await reloadFromIndexedDB().catch(()=>{});
    await syncFolder('temples',DRIVE.TEMPLES_FOLDER_ID);
    await syncFolder('face',   DRIVE.FACES_FOLDER_ID);
    driveNote.textContent="";
  }catch(e){
    console.error("BOOT ERROR",e);
    driveNote.textContent="";
  }
})();
</script>

<div id="toast" class="toast">⭐ Ajouté aux favoris</div>

</body>
</html>
