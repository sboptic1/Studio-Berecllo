<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Studio Berecllo — By S.B (Proxy préféré + API fallback)</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect rx='12' ry='12' width='64' height='64' fill='%23000'/%3E%3Ctext x='50%25' y='54%25' dominant-baseline='middle' text-anchor='middle' fill='%23fff' font-family='Helvetica Neue' font-size='28' font-weight='300'%3EB%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600&display=swap" rel="stylesheet">
<style>
:root{--headerH:95px;--border:#e6e8ee;--gold1:#fff4c2;--gold2:#f1d98a;--gold3:#e0c066;--gold4:#b8943e;--gold5:#f9e9ad}
*{box-sizing:border-box}
body{margin:0;background:#f6f7fa;color:#111;font:15px/1.6 'Helvetica Neue',Helvetica,Arial,sans-serif}
.header-wrap{position:fixed;inset:0 0 auto 0;height:var(--headerH);background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.05)}
.brand a{display:flex;align-items:center;height:100%}
.brand img{height:60px;width:auto;display:block;filter:brightness(0)}
.title{font:300 22px/1 'Helvetica Neue',sans-serif;letter-spacing:.06em;color:#111}
.page{padding-top:calc(var(--headerH) + 20px)}
.wrap{max-width:1760px;margin:0 auto;padding:0 24px}
.grid{display:grid;grid-template-columns:minmax(0,1fr) 420px;gap:32px}
@media (max-width:1200px){.grid{grid-template-columns:1fr}}
.card{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:0 12px 30px rgba(0,0,0,.06)}
.viewer{position:relative;aspect-ratio:2048/1265;width:100%;border-radius:20px;overflow:hidden;background:#eef2f7;display:flex;align-items:center;justify-content:center}
canvas{width:100%;height:100%;display:block}
.model-label{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);padding:12px 18px;border-radius:14px;background:rgba(255,255,255,.96);border:1px solid rgba(0,0,0,.1);backdrop-filter:blur(6px);font:300 21px/1.2 'Helvetica Neue',sans-serif;letter-spacing:.12em;color:#0b0d10}
.toolbar{display:flex;justify-content:flex-end;gap:12px;padding:16px 20px;border-top:1px solid var(--border)}
.btn3d{cursor:pointer;border:none;border-radius:12px;padding:12px 18px;font:400 15px/1.1 'Helvetica Neue',sans-serif;color:#111;background:#fff;position:relative;isolation:isolate;box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 6px 16px rgba(0,0,0,.08);transition:transform .1s,box-shadow .15s}
.btn3d::before{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;background:conic-gradient(from 210deg,#dfe7f4,#a8b9d0,#6f87a6,#e9f0fb,#8aa3c7,#dfe7f4);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.btn3d:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.15)}
.btn3d.plus{width:46px;height:44px;font-size:22px}
.side{display:flex;flex-direction:column;gap:22px}
.panel{background:#fff;border:1px solid var(--border);border-radius:18px;padding:16px 16px 20px}
.panel h2{font:600 18px 'Montserrat',sans-serif;margin:0 0 10px;display:flex;justify-content:space-between;align-items:center;color:#111}
.gal{display:grid;grid-template-columns:repeat(5,1fr);gap:14px}
.thumb{position:relative;border-radius:12px;overflow:hidden;min-height:80px;display:flex;align-items:center;justify-content:center;background:#fafafa;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,.9),0 6px 14px rgba(0,0,0,.06);transition:all .2s;font-family:'Montserrat',sans-serif;font-weight:600}
.thumb::before{content:'';position:absolute;inset:0;border-radius:12px;padding:2px;pointer-events:none;-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;background:linear-gradient(180deg,#fdfdfd,#f2f2f2)}
.thumb:hover{transform:translateY(-2px);filter:brightness(1.05)}
.thumb[aria-selected=true]::before{background:conic-gradient(from 0deg,var(--gold1),var(--gold2),var(--gold3),var(--gold4),var(--gold5),var(--gold1));border:3px solid transparent}
.thumb[aria-selected=true]{color:#000;box-shadow:0 0 10px rgba(255,215,0,.5),inset 0 0 4px rgba(255,255,255,.9)}
.badge{font:600 13px 'Montserrat',sans-serif;color:#111;letter-spacing:.06em}
input[type=file].hidden{display:none}
.toast{position:fixed;left:50%;bottom:40px;transform:translateX(-50%);background:rgba(255,255,255,.95);border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:12px 22px;font:600 15px 'Montserrat',sans-serif;color:#000;box-shadow:0 4px 20px rgba(0,0,0,.15);opacity:0;pointer-events:none;transition:opacity .4s}
.toast.show{opacity:1}
.note{margin:10px 0 0 0;font:600 12px 'Montserrat',sans-serif;color:#8a8f9a}
</style>
</head>
<body>
<header class="header-wrap">
  <div class="brand">
    <a href="https://berecllo.fr/" target="_blank" title="Visiter le site Berecllo">
      <img src="https://berecllo.fr/wp-content/uploads/2024/03/Logo-Berecllo_En-tete.svg" alt="Berecllo">
    </a>
  </div>
  <h1 class="title">Studio Berecllo — By&nbsp;S.B</h1>
</header>

<div class="page"><div class="wrap"><div class="grid">
  <div class="card">
    <div class="viewer" id="dropZone">
      <canvas id="cv" width="2048" height="1265"></canvas>
      <div class="model-label" id="modelLabel">—</div>
    </div>
    <div class="toolbar">
      <button id="btnFav" class="btn3d">❤ Favoris</button>
      <button id="btnShare" class="btn3d">⇪ Partager</button>
      <button id="btnExport" class="btn3d">⬇ Exporter</button>
    </div>
    <p class="note" id="driveNote">Préférence proxy…</p>
  </div>

  <aside class="side">
    <div class="panel">
      <h2>Faces <button class="btn3d plus" id="btnAddFaces">+</button></h2>
      <input id="inFaces" class="hidden" type="file" accept="image/*" multiple>
      <div id="galFaces" class="gal"></div>
    </div>
    <div class="panel">
      <h2>Branches <button class="btn3d plus" id="btnAddTemples">+</button></h2>
      <input id="inTemples" class="hidden" type="file" accept="image/*" multiple>
      <div id="galTemples" class="gal"></div>
    </div>
    <div class="panel">
      <h2>Favoris</h2>
      <div id="galFavs" class="gal"></div>
    </div>
  </aside>
</div></div></div>

<div id="toast" class="toast">⭐ Ajouté aux favoris</div>

<script>
/* ====== CONFIG (Proxy préféré + API fallback) ====== */
const DRIVE = {
  API_KEY: "AIzaSyAGTWwPZRyT6P8G2FlfeCRPnlADalQmE-0",
  FACES_FOLDER_ID: "1sYQqBv9T_CFFeJBS_9otKVz6Q1HONoBx",
  TEMPLES_FOLDER_ID: "1Uorpg-crCvjlAsYq4Lky2yGRxV2iWwEf",
  WORKER_URL: "https://berecllo-proxy1.sb-optic1.workers.dev"
};

const endp = {
  apiList: (folderId)=>{
    const base = "https://www.googleapis.com/drive/v3/files";
    const q = new URLSearchParams({
      key: DRIVE.API_KEY,
      q: `'${folderId}' in parents and trashed=false`,
      fields: "files(id,name,mimeType)",
      pageSize: 1000,
      orderBy: "name"
    }).toString();
    return base + "?" + q;
  },
  apiDownload: (id)=>`https://drive.google.com/uc?export=download&id=${encodeURIComponent(id)}`,
  prox: (url)=>{
    const u = new URL(DRIVE.WORKER_URL);
    u.searchParams.set('u', url);
    return u.toString();
  }
};

/* ====== App (valeur sûre) ====== */
const cv=document.getElementById('cv'),ctx=cv.getContext('2d',{willReadFrequently:true});
const galFaces=document.getElementById('galFaces'),galTemples=document.getElementById('galTemples');
const inFaces=document.getElementById('inFaces'),inTemples=document.getElementById('inTemples');
const modelLabel=document.getElementById('modelLabel');
const galFavs=document.getElementById('galFavs');
const toast=document.getElementById('toast');
const dropZone=document.getElementById('dropZone');
const driveNote=document.getElementById('driveNote');

const state={faces:[],temples:[],selFace:null,selTemples:null,favs:[],tol:60};

let db;
const DB_NAME='berecllo-store', DB_VER=1;
function openDB(){return new Promise((resolve,reject)=>{const req=indexedDB.open(DB_NAME,DB_VER);req.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains('images'))d.createObjectStore('images',{keyPath:'id'});if(!d.objectStoreNames.contains('meta'))d.createObjectStore('meta',{keyPath:'key'})};req.onsuccess=()=>{db=req.result;resolve(db)};req.onerror=()=>reject(req.error)})}
function idFor(type,name){return `${type}|${name}`}
function putImage(type,name,blob){return new Promise((resolve,reject)=>{const tx=db.transaction('images','readwrite');tx.objectStore('images').put({id:idFor(type,name),name,type,blob});tx.oncomplete=()=>resolve();tx.onerror=()=>reject(tx.error)})}
function getAllImages(){return new Promise((resolve,reject)=>{const tx=db.transaction('images','readonly');const r=tx.objectStore('images').getAll();r.onsuccess=()=>resolve(r.result||[]);r.onerror=()=>reject(r.error)})}
function saveMeta(key,val){return new Promise((resolve,reject)=>{const tx=db.transaction('meta','readwrite');tx.objectStore('meta').put({key,value:val});tx.oncomplete=()=>resolve();tx.onerror=()=>reject(tx.error)})}
function loadMeta(key){return new Promise((resolve,reject)=>{const tx=db.transaction('meta','readonly');const r=tx.objectStore('meta').get(key);r.onsuccess=()=>resolve(r.result?r.result.value:null);r.onerror=()=>reject(r.error)})}

function imgFromBlob(blob){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>res(img);img.onerror=rej;img.src=URL.createObjectURL(blob)})}
function imgFromFile(file){return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>resolve(img);img.onerror=reject;const fr=new FileReader();fr.onerror=()=>{try{img.src=URL.createObjectURL(file)}catch(e){reject(e)}};fr.onload=()=>{img.src=fr.result};fr.readAsDataURL(file)})}

function removeBackgroundAuto(img,tol){
  const w=img.naturalWidth||img.width,h=img.naturalHeight||img.height;
  const c=document.createElement('canvas');c.width=w;c.height=h;
  const x=c.getContext('2d',{willReadFrequently:true});x.drawImage(img,0,0);
  const data=x.getImageData(0,0,w,h);const d=data.data;
  const margin=Math.floor(Math.min(w,h)*0.03),steps=10;let r=0,g=0,b=0,n=0;
  const pick=(sx,sy)=>{const o=(sy*w+sx)*4;r+=d[o];g+=d[o+1];b+=d[o+2];n++};
  for(let i=0;i<=steps;i++){const t=Math.floor(i*(w-1)/steps),u=Math.floor(i*(h-1)/steps);
    pick(t,margin);pick(t,h-1-margin);pick(margin,u);pick(w-1-margin,u)}
  r/=n;g/=n;b/=n;
  for(let i=0;i<d.length;i+=4){
    const dr=d[i]-r,dg=d[i+1]-g,db=d[i+2]-b;
    if(Math.sqrt(dr*dr+dg*dg+db*db)<tol){d[i+3]=0}
  }
  x.putImageData(data,0,0);
  const out=new Image();out.src=c.toDataURL('image/png');return out
}
function faceLabel(n){return n.split('/').pop().replace(/\.[^.]+$/,'').toUpperCase()}
function templesLabel(n){return n.split('/').pop().replace(/\.[^.]+$/,'').toLowerCase()}
function updateLabel(){
  const f=state.selFace?faceLabel(state.selFace.name):'';
  const t=state.selTemples?templesLabel(state.selTemples.name):'';
  modelLabel.textContent=f&&t?`${f} - ${t}`:(f||t||'—')
}
function redraw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(state.selTemples?.img)ctx.drawImage(state.selTemples.img,0,0,cv.width,cv.height);
  if(state.selFace?.proc)ctx.drawImage(state.selFace.proc,0,0,cv.width,cv.height);
  updateLabel();persistSelection()
}

/* ==== DÉTECTION DE DOUBLONS (faces / branches) ==== */
function hasName(type, name){
  const arr = (type==='face') ? state.faces : state.temples;
  return arr.some(x=>x.name===name);
}
function toastMsg(txt){
  toast.textContent = txt;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'),1400);
}

function select(g,obj,isFace,btn){
  if(isFace)state.selFace=obj;else state.selTemples=obj;
  [...g.children].forEach(c=>c.setAttribute('aria-selected','false'));
  btn.setAttribute('aria-selected','true');redraw()
}
function addToGallery(g,arr,obj,isFace){
  arr.push(obj);
  const btn=document.createElement('button');
  btn.type='button';btn.className='thumb '+(isFace?'face':'temples');
  const label=isFace?faceLabel(obj.name):templesLabel(obj.name);
  btn.innerHTML=`<span class="badge">${label}</span>`;
  btn.onclick=()=>select(g,obj,isFace,btn);
  g.appendChild(btn);select(g,obj,isFace,btn)
}

async function handle(files,isFace){
  await openDBIfNeeded();
  for(const f of files){
    if(!f.type.startsWith('image/'))continue;
    const name = f.name;
    // skip si doublon de nom
    if(hasName(isFace?'face':'temples', name)){
      toastMsg('Déjà présent : '+name);
      continue;
    }
    try{
      const img=await imgFromFile(f);
      await putImage(isFace?'face':'temples',name,await fileToBlob(f));
      if(isFace){
        const proc=removeBackgroundAuto(img,state.tol);proc.onload=()=>redraw();
        addToGallery(galFaces,state.faces,{name,img,proc},true)
      }else{
        addToGallery(galTemples,state.temples,{name: name,img},false)
      }
    }catch(err){console.error('Échec chargement image :',err)}
  }
  await persistLists();redraw()
}
function fileToBlob(file){return new Blob([file],{type:file.type||'image/png'})}

async function reloadPersisted(){
  await openDBIfNeeded();
  const list=await getAllImages();
  const metaFaces=await loadMeta('facesNames')||[];
  const metaTempl=await loadMeta('templesNames')||[];
  const sel=await loadMeta('selection')||{face:null,temples:null};
  const byKey=Object.fromEntries(list.map(it=>[idFor(it.type,it.name),it]));
  const faceNames=[...new Set([...metaFaces,...list.filter(x=>x.type==='face').map(x=>x.name)])];
  const templNames=[...new Set([...metaTempl,...list.filter(x=>x.type==='temples').map(x=>x.name)])];

  for(const name of faceNames){
    const rec=byKey[idFor('face',name)]; if(!rec)continue;
    // Pas de doublons ici : addToGallery sur reconstruction initiale
    const img=await imgFromBlob(rec.blob);
    const proc=removeBackgroundAuto(img,state.tol);proc.onload=()=>redraw();
    addToGallery(galFaces,state.faces,{name,img,proc},true)
  }
  for(const name of templNames){
    const rec=byKey[idFor('temples',name)]; if(!rec)continue;
    const img=await imgFromBlob(rec.blob);
    addToGallery(galTemples,state.temples,{name,img},false)
  }
  if(sel.face){const f=state.faces.find(x=>x.name===sel.face);if(f)state.selFace=f}
  if(sel.temples){const t=state.temples.find(x=>x.name===sel.temples);if(t)state.selTemples=t}
  redraw()
}
async function persistLists(){
  const facesNames=state.faces.map(x=>x.name);
  const templesNames=state.temples.map(x=>x.name);
  await saveMeta('facesNames',facesNames);
  await saveMeta('templesNames',templesNames)
}
async function persistSelection(){
  await saveMeta('selection',{face:state.selFace?.name||null,temples:state.selTemples?.name||null})
}
async function openDBIfNeeded(){if(!db)await openDB()}

/* ====== Chargement Drive : Proxy préféré → fallback API + skip doublons ====== */
async function fetchJson(url){const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json()}
async function fetchBlob(url){const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.blob()}

function listViaProxy(folderId){return fetchJson(endp.prox(endp.apiList(folderId)))}
function listViaApi(folderId){return fetchJson(endp.apiList(folderId))}
function downloadViaProxy(id){return fetchBlob(endp.prox(endp.apiDownload(id)))}
function downloadViaApi(id){return fetchBlob(endp.apiDownload(id))}

async function loadFolder(type, folderId, preferProxy=true){
  let listing;
  try{
    if(preferProxy){ listing = await listViaProxy(folderId); driveNote.textContent="🔵 Proxy actif — listing"; }
    else { listing = await listViaApi(folderId); driveNote.textContent="🟢 API directe — listing"; }
  }catch(e){
    if(preferProxy){
      driveNote.textContent="🟡 Proxy KO, essai API directe…";
      listing = await listViaApi(folderId);
    }else{
      driveNote.textContent="🟡 API KO, essai Proxy…";
      listing = await listViaProxy(folderId);
    }
  }
  const files=(listing.files||[]).filter(f=> (f.mimeType||'').startsWith('image/'));
  for(const it of files){
    const name = it.name || (it.id + ".png");
    // Skip si doublon (évite téléchargement + écrasement)
    if(hasName(type, name)){
      toastMsg('Déjà présent : '+name);
      continue;
    }
    let blob;
    try{
      blob = preferProxy ? await downloadViaProxy(it.id) : await downloadViaApi(it.id);
    }catch(_){
      // Inverse pour le téléchargement si la méthode préférée échoue
      blob = preferProxy ? await downloadViaApi(it.id) : await downloadViaProxy(it.id);
    }
    await putImage(type, name, blob);
    const img = await imgFromBlob(blob);
    if(type==='face'){
      const proc = removeBackgroundAuto(img, state.tol);
      proc.onload = ()=>redraw();
      addToGallery(galFaces, state.faces, {name, img, proc}, true);
    }else{
      addToGallery(galTemples, state.temples, {name, img}, false);
    }
  }
}

async function loadAll(){
  try{
    driveNote.textContent="Préférence proxy…";
    await loadFolder('temples', DRIVE.TEMPLES_FOLDER_ID, true);
    await loadFolder('face',    DRIVE.FACES_FOLDER_ID,   true);
    await persistLists(); redraw();
    driveNote.textContent="✔ Import terminé (proxy privilégié + fallback)";
  }catch(e){
    console.warn("Import KO", e);
    driveNote.textContent="Import Drive impossible. Utilisez les boutons “+” pour un import manuel.";
  }
}

/* --------- Export / Partage / Favoris --------- */
function slugifyForFilename(s){return (s||'berecllo').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\- ]+/g,'').replace(/\s+/g,'_').replace(/_+/g,'_').replace(/^_+|_+$/g,'')}
document.getElementById('btnExport').onclick=()=>cv.toBlob(b=>{const base=slugifyForFilename(modelLabel.textContent||'berecllo');const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=base+'.png';a.click()});
document.getElementById('btnShare').onclick=()=>cv.toBlob(async b=>{const base=slugifyForFilename(modelLabel.textContent||'berecllo');const f=new File([b],base+'.png',{type:'image/png'});if(navigator.canShare&&navigator.canShare({files:[f]}))await navigator.share({files:[f],title:'Berecllo',text:modelLabel.textContent||''})});

function renderFavs(){
  galFavs.innerHTML='';
  state.favs.forEach(fv=>{
    const btn=document.createElement('button');
    btn.className='thumb';btn.type='button';
    btn.innerHTML=`<span class="badge">${fv.label}</span>`;
    btn.onclick=()=>{
      state.selFace=state.faces.find(x=>x.name===fv.face)||state.selFace;
      state.selTemples=state.temples.find(x=>x.name===fv.temples)||state.selTemples;
      redraw()
    };
    galFavs.appendChild(btn)
  })
}
async function saveFavs(){await saveMeta('favs',state.favs.map(f=>({face:f.face,temples:f.temples,label:f.label})))}
async function loadFavs(){const favs=await loadMeta('favs')||[];state.favs=favs.slice(0,5);renderFavs()}
const toastEl=document.getElementById('toast');function showToast(){toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),1400)}
document.getElementById('btnFav').onclick=async ()=>{
  if(!state.selFace||!state.selTemples)return;
  const label=modelLabel.textContent;
  if(state.favs.find(f=>f.face===state.selFace.name&&f.temples===state.selTemples.name))return;
  state.favs.unshift({face:state.selFace.name,temples:state.selTemples.name,label});
  if(state.favs.length>5)state.favs.pop();
  await saveFavs();renderFavs();toastMsg('⭐ Ajouté aux favoris');
};

/* --------- Drag & Drop + Inputs --------- */
['dragenter','dragover','dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,(e)=>{e.preventDefault();e.stopPropagation()}));
dropZone.addEventListener('drop',(e)=>{
  const files=e.dataTransfer.files||[];
  const faces=[...files].filter(f=>/face|front|_f/i.test(f.name));
  const temples=[...files].filter(f=>/branch|temple|_t/i.test(f.name));
  const others=[...files].filter(f=>!faces.includes(f)&&!temples.includes(f));
  if(faces.length)handle(faces,true);
  if(temples.length)handle(temples,false);
  if(others.length&&!faces.length&&!temples.length){handle([others[0]],false);if(others[1])handle([others[1]],true)}
});
document.getElementById('btnAddFaces').onclick=()=>{inFaces.value='';inFaces.click()};
document.getElementById('btnAddTemples').onclick=()=>{inTemples.value='';inTemples.click()};
inFaces.addEventListener('change',e=>handle(e.target.files,true));
inTemples.addEventListener('change',e=>handle(e.target.files,false));

/* --------- Boot --------- */
(async function boot(){
  try{
    await openDBIfNeeded();await loadFavs();await reloadPersisted();await loadAll();
  }catch(e){console.warn('Persistance indisponible',e)}
})();
</script>
</body>
</html>
